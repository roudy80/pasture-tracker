<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasture Tracker</title>
<!-- REMOVED LEAFLET - Using custom image-based system -->
    <link rel="manifest" href="data:application/json,{%22name%22:%22Pasture%20Tracker%22,%22short_name%22:%22Pasture%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%23228B22%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%3E%3Crect%20fill='%23228B22'%20width='100'%20height='100'/%3E%3Ctext%20y='70'%20font-size='60'%20text-anchor='middle'%20x='50'%20fill='white'%3EP%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22any%22,%22type%22:%22image/svg+xml%22}]}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #228B22 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255,255,255,0.9);
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #228B22;
            margin-bottom: 0.5rem;
        }
        
        .location {
            color: #666;
            font-size: 0.9rem;
        }
        
        .container {
            padding: 1rem;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .tab-navigation {
    display: flex;
    background: white;
    border-radius: 15px 15px 0 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 0;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
        
        .tab-button {
    flex: none;
    min-width: 120px;
    padding: 1rem;
    background: none;
    border: none;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    color: #666;
    transition: all 0.3s;
    border-radius: 15px 15px 0 0;
    white-space: nowrap;
}
        
        .tab-button.active {
            background: #228B22;
            color: white;
        }
        
        .tab-button:hover:not(.active) {
            background: #f8f9fa;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 15px 15px;
            min-height: 200px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 1rem;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .weather-card {
            background: transparent;
            border-radius: 15px;
            padding: 0;
            margin-bottom: 1rem;
            box-shadow: none;
        }
        
        .weather-card .current-weather {
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 1rem;
        }
        
        .weather-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .current-weather {
            text-align: center;
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            padding: 2rem 1rem;
        }
        
        .weather-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            background-size: cover;
            background-position: center;
            z-index: 1;
        }
        
        .weather-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }
        
        .temp {
            font-size: 3rem;
            font-weight: bold;
            color: #228B22;
            margin: 0.5rem 0;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(255,255,255,0.8);
        }
        
        .conditions {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }
        
        .hourly-rain {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }
        
        .rain-title {
            font-size: 0.9rem;
            color: #1976d2;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .rain-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d47a1;
        }
        
        .rain-prob {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .detail-item {
            text-align: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-label {
            font-size: 0.8rem;
            color: #666;
        }
        
        .detail-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }
        
        .burn-ban-controls {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .county-links {
            margin-bottom: 1rem;
        }
        
        .county-link {
            padding: 0.75rem;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            transition: background 0.3s;
            display: block;
        }
        
        .county-link:hover {
            background: #0056b3;
            color: white;
        }
        
        .burn-ban-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 1rem 0;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #dc3545;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(25px);
        }
        
        .date-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-left: 0.5rem;
        }
        
        .alerts {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .fire-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .fire-alert.moderate {
            background: #fff3cd;
            border: 1px solid #ffc107;
        }
        
        .fire-alert.high {
            background: #f8d7da;
            border: 1px solid #dc3545;
        }
        
        .fire-alert.extreme {
            background: #d1ecf1;
            border: 1px solid #dc3545;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .risk-level {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .risk-low {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .risk-moderate {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .risk-high {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .risk-extreme {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            animation: pulse 2s infinite;
        }
        
        .alert-title {
            color: #856404;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .alert-content {
            color: #664d03;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .btn {
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #228B22;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .photo-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .photo-item {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 14px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-btn:hover {
            background: rgba(255, 0, 0, 1);
        }
        
        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .photo-item img:hover {
            opacity: 0.9;
        }
        
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .photo-modal img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: 10px;
        }
        
        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 2001;
        }
        
        .photo-modal-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }
        
        .photo-info {
            padding: 0.5rem;
            background: #f8f9fa;
            font-size: 0.8rem;
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
       .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .pastures-container {
            margin-top: 1rem;
        }
        
        .pasture-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #228B22;
        }
        
        .pasture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .pasture-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #228B22;
            margin: 0;
        }
        
        .pasture-stats {
            font-size: 0.9rem;
            color: #666;
        }
        
        .pasture-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-edit {
            background: #ffc107;
            color: #000;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .btn-small:hover {
            opacity: 0.8;
        }
        
        .pasture-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.2rem;
        }
        
        .info-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }
        
        .empty-pasture {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 1rem;
        }
        
        .empty-animals {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 1rem;
        }
        
        .animal-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #ff6b35;
        }
        
        .animal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .animal-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ff6b35;
            margin: 0;
        }
        
        .animal-type {
            font-size: 0.9rem;
            color: #666;
            text-transform: capitalize;
        }
        
        .animal-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #ff6b35;
            background: white;
            color: #ff6b35;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #ff6b35;
            color: white;
        }
        
        .filter-btn:hover {
            background: #ff6b35;
            color: white;
        }
        
        .assign-photo-btn {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(34, 139, 34, 0.9);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            z-index: 10;
        }
        
        .assign-photo-btn:hover {
            background: rgba(34, 139, 34, 1);
        }
        
        #cameraInput {
            margin-bottom: 1rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .hidden {
            display: none;
        }
        
        .forecast {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .forecast-day {
            text-align: center;
            padding: 1rem 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .forecast-date {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .forecast-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .forecast-temps {
            margin-bottom: 0.5rem;
        }
        
        .forecast-high {
            font-weight: bold;
            color: #228B22;
            font-size: 1.1rem;
        }
        
        .forecast-low {
            color: #666;
            font-size: 0.9rem;
            margin-left: 0.25rem;
        }
        
        .forecast-peak-time {
            font-size: 0.7rem;
            color: #888;
            margin-top: 0.25rem;
        }
        
        .forecast-desc {
            font-size: 0.7rem;
            color: #666;
            margin-top: 0.25rem;
        }

.materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .material-item {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }

        .material-item.obtained {
            opacity: 0.7;
            border-left-color: #28a745;
        }

        .material-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .material-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
        }

        .material-name.obtained {
            text-decoration: line-through;
            color: #28a745;
        }

        .material-category {
            font-size: 0.8rem;
            color: #666;
            background: #f8f9fa;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
        }

        .material-progress {
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .progress-bar {
            background: #f0f0f0;
            border-radius: 10px;
            height: 6px;
            margin: 0.25rem 0;
        }

        .progress-fill {
            background: #28a745;
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s;
        }

        .material-cost {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }

        .material-notes {
            font-size: 0.8rem;
            color: #666;
            font-style: italic;
            margin-top: 0.5rem;
        }

        .material-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn-obtain {
            background: #28a745;
            color: white;
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .filter-materials {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-materials {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        /* CUSTOM SHREDDING AREA STYLES */
        .shredding-area {
            position: absolute;
            border: 3px solid;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            color: white;
            text-align: center;
            line-height: 1.2;
        }

        .shredding-area:hover {
            transform: scale(1.05);
            border-width: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .shredding-area.edit-mode {
            border-style: dashed;
            border-width: 2px;
        }

        .shredding-area.selected {
            border-color: #007bff !important;
            border-width: 4px;
            box-shadow: 0 0 15px rgba(0,123,255,0.5);
        }

        /* Color coding based on days since last shredded */
        .shredding-area.recent {
            background-color: rgba(40, 167, 69, 0.7);
            border-color: #28a745;
        }

        .shredding-area.needs-attention {
            background-color: rgba(255, 193, 7, 0.7);
            border-color: #ffc107;
        }

        .shredding-area.overdue {
            background-color: rgba(220, 53, 69, 0.7);
            border-color: #dc3545;
        }

        .shredding-area.never-shredded {
            background-color: rgba(108, 117, 125, 0.7);
            border-color: #6c757d;
        }

        /* Shape variants */
        .shredding-area.circle {
            border-radius: 50%;
        }

        .shredding-area.rectangle {
            border-radius: 8px;
        }

        .shredding-area.oval {
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
}

.shredding-area.square {
    border-radius: 4px;
}

.shredding-area.square {
    aspect-ratio: 1;
}

.ranch-line {
            cursor: pointer;
            z-index: 5;
        }
        
        .ranch-line.property {
            background: #dc3545;
        }
        
        .ranch-line.fence {
            background: #000000;
        }
        
        .ranch-line.driveway {
            background: #8e44ad;
        }
        
        .ranch-line.reference {
            background: #6c757d;
        }
        
        .ranch-line.water {
            background: #007bff;
        }
        
        .ranch-line.power {
            background: #ffc107;
        }
        
        .ranch-line.gas {
            background: #8b4513;
        }
        
        .ranch-line.irrigation {
            background: #fd7e14;
        }
        
        .ranch-line.septic {
            background: #e9ecef;
        }
        
        .ranch-line.easement {
            background: #28a745;
        }
        
        .ranch-line.dashed {
            background: repeating-linear-gradient(
                to right,
                currentColor 0px,
                currentColor 10px,
                transparent 10px,
                transparent 20px
            );
        }        
        
        /* Cannabis Leaf Icon */
        .weed-leaf {
    display: inline-block;
    width: 16px;
    height: 16px;
    position: relative;
    margin-right: 4px;
    vertical-align: middle;
}

.weed-leaf::before {
    content: 'üçÉ';
    font-size: 14px;
    position: absolute;
    top: 1px;
    left: 1px;
}

        .species-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #6c757d;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .species-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .species-card.active-season {
            border-left-color: #dc3545;
            background: #fff8f8;
        }
        
        .species-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .species-header h3 {
            margin: 0;
            color: #228B22;
        }
        
        .species-type {
            background: #e9ecef;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #495057;
        }
        
        .species-scientific {
            font-style: italic;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        
        .species-description {
            color: #333;
            margin-bottom: 0.75rem;
        }
        
        .species-current-action {
            background: #e3f2fd;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .species-identifiers {
            font-size: 0.8rem;
            color: #666;
        }
        
        .detail-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .detail-section h3 {
            margin: 0 0 0.75rem 0;
            color: #495057;
        }
        
        .detail-section ul {
            margin: 0;
            padding-left: 1.5rem;
        }
        
        .detail-section li {
            margin-bottom: 0.25rem;
        }

        /* Spray Calculator Styles */
        .calc-inputs {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }
        
        .calc-inputs .form-group {
            margin-bottom: 1rem;
        }
        
        .calc-inputs label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .calc-inputs select,
        .calc-inputs input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .calc-inputs select:focus,
        .calc-inputs input[type="number"]:focus {
            outline: none;
            border-color: #228B22;
            box-shadow: 0 0 0 3px rgba(34, 139, 34, 0.1);
        }
        
        .calc-inputs input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 0.5rem;
            accent-color: #228B22;
        }
        
        .calc-inputs small {
            font-size: 0.85rem;
            line-height: 1.3;
        }
        
        .calc-results {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
        }
        
        .calc-results h4 {
            color: #228B22;
            margin: 0 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .calc-results h5 {
            color: #495057;
            margin: 1.5rem 0 0.75rem 0;
            font-size: 1.1rem;
        }
        
        .calc-summary {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .calc-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .calc-item:last-child {
            margin-bottom: 0;
        }
        
        .calc-label {
            font-weight: 600;
            color: #1976d2;
        }
        
        .calc-value {
            font-weight: 700;
            color: #0d47a1;
        }
        
        .per-tank-mix {
            background: #fff3cd;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        
        .mix-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #ffeaa7;
        }
        
        .mix-item:last-child {
            border-bottom: none;
        }
        
        .mix-chemical {
            font-weight: 600;
            color: #856404;
        }
        
        .mix-amount {
            font-weight: 700;
            color: #533f03;
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        
        .cost-breakdown {
            background: #d4edda;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px solid #c3e6cb;
        }
        
        .cost-item:last-child {
            border-bottom: none;
        }
        
        .cost-item.total-cost {
            margin-top: 0.5rem;
            padding-top: 0.75rem;
            border-top: 2px solid #28a745;
            font-size: 1.1rem;
        }
        
        .cost-item span:first-child {
            color: #155724;
        }
        
        .cost-item span:last-child {
            color: #0a4622;
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .calc-notes {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
            margin-top: 1.5rem;
        }
        
        .calc-notes h5 {
            color: #495057;
            margin: 0 0 0.75rem 0;
        }
        
        .calc-notes p {
            margin: 0.5rem 0;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .calc-notes p:first-of-type {
            font-weight: 600;
            color: #495057;
        }
        
        /* Make calculator modal wider on larger screens */
        @media (min-width: 768px) {
            #calculatorModal .modal-content {
                max-width: 700px;
            }
        }
        
        /* Responsive calculator on mobile */
        @media (max-width: 767px) {
            .calc-inputs {
                padding: 1rem;
            }
            
            .calc-results {
                padding: 1rem;
            }
            
            .mix-item,
            .cost-item,
            .calc-item {
                font-size: 0.9rem;
            }
            
            .calc-results h4 {
                font-size: 1.2rem;
            }
        }

/* Responsive calculator on mobile */
        @media (max-width: 767px) {
            .calc-inputs {
                padding: 1rem;
            }
            
            .calc-results {
                padding: 1rem;
            }
            
            .mix-item,
            .cost-item,
            .calc-item {
                font-size: 0.9rem;
            }
            
            .calc-results h4 {
                font-size: 1.2rem;
            }
        }   <-- ADD THE NEW CSS RIGHT AFTER THIS BRACKET
        
        .tank-breakdown {
            margin: 1rem 0;
        }
        
        .tank-mix {
            background: #fff8dc;
            border: 2px solid #daa520;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .tank-mix h6 {
            margin: 0 0 0.75rem 0;
            color: #b8860b;
            font-weight: bold;
            text-align: center;
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
        }

        
    </style>
</head>
<body>
    <div class="header">
        <h1>üåæ Pasture Tracker</h1>
        <div class="location">LaGrange - Schulenburg, TX</div>
    </div>

    <div class="tab-navigation">
    <button class="tab-button active" onclick="switchTab('weather')">üå§Ô∏è Weather</button>
    <button class="tab-button" onclick="switchTab('pasture')">üåæ Pasture</button>
    <button class="tab-button" onclick="switchTab('animals')">üêÑ Animals</button>
    <button class="tab-button" onclick="switchTab('weed')"><span class="weed-leaf"></span> Weed</button>
    <button class="tab-button" onclick="switchTab('map')">üó∫Ô∏è Map</button>
    <button class="tab-button" onclick="switchTab('projects')">üîß Projects</button>
</div>
        
        <!-- Weather Tab -->
        <div id="weatherTab" class="tab-content active">
            <div class="weather-card">
                <div id="weatherContent" class="loading">
                    Loading weather data...
                </div>
            </div>
            
            <div class="burn-ban-controls">
                <h3>üî• Burn Ban Status</h3>
                
                <div class="county-links">
                    <a href="https://www.co.fayette.tx.us/" target="_blank" class="county-link">
                        Check Fayette County Status
                    </a>
                </div>
                
                <div class="burn-ban-toggle">
                    <span><strong>Fayette County Burn Ban:</strong></span>
                    <div>
                        <span id="fayetteStatus">OFF</span>
                        <div class="toggle-switch" id="fayetteToggle" onclick="toggleBurnBan('fayette')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
                
                <div id="fayetteExpiry" class="hidden">
                    <label>Expires: <input type="date" id="fayetteDate" class="date-input" onchange="updateBurnBanDate('fayette')"></label>
                </div>
            </div>
            
            <div id="fireAlertsSection" class="hidden">
                <div class="fire-alert" id="fireAlertContainer">
                    <h3>üî• Fire Weather Assessment</h3>
                    <div id="fireRiskLevel" class="risk-level risk-low">FIRE RISK: LOW</div>
                    <div id="fireAlertContent" class="alert-content"></div>
                </div>
            </div>
            
            <div id="alertsSection" class="hidden">
                <div class="alerts">
                    <div class="alert-title">üå± Pasture Alert</div>
                    <div id="alertContent" class="alert-content"></div>
                </div>
            </div>
        </div>
        
        <!-- Pasture Tab -->
        <div id="pastureTab" class="tab-content">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="managePastures()">üåæ Manage Pastures</button>
                <button class="btn btn-secondary" onclick="takePhoto()">üì∏ Log Photo</button>
                <button class="btn btn-secondary" onclick="addNote()">üìù Add Note</button>
            </div>
            
            <div id="pasturesList" class="pastures-container">
                <!-- Individual pastures will be displayed here -->
            </div>
            
            <div id="unassignedPhotos" class="photo-section hidden">
                <h3>üì∑ Unassigned Photos</h3>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                    Photos not yet assigned to a pasture. Click "Assign to Pasture" to organize them.
                </p>
                <div id="unassignedGrid" class="photo-grid">
                    <!-- Unassigned photos will be added here -->
                </div>
            </div>
        </div>
        
        <!-- Animals Tab -->
        <div id="animalsTab" class="tab-content">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="addAnimal()">üêÑ Add Animal</button>
                <button class="btn btn-secondary" onclick="addTreatment()">üíâ Add Treatment</button>
                <button class="btn btn-secondary" onclick="testNotification()">üîî Test Alert</button>
                <button class="btn btn-secondary" onclick="checkTreatmentNotifications(); checkBreedingNotifications();">üíâ Check Treatments</button>
            </div>
            
            <div class="animal-filters">
                <button class="filter-btn active" onclick="filterAnimals('all')">üêæ All</button>
                <button class="filter-btn" onclick="filterAnimals('cattle')">üêÑ Cattle</button>
                <button class="filter-btn" onclick="filterAnimals('horses')">üê¥ Horses</button>
                <button class="filter-btn" onclick="filterAnimals('chickens')">üêì Chickens</button>
                <button class="filter-btn" onclick="filterAnimals('dogs')">üêï Dogs</button>
            </div>

            <!-- Treatment Alerts Dashboard -->
            <div id="treatmentAlertsSection" class="hidden" style="margin: 1rem 0; padding: 1rem; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                <h3 style="margin: 0 0 0.5rem 0; color: #856404;">‚ö†Ô∏è Upcoming Treatments & Events</h3>
                <div id="treatmentAlertsList" style="font-size: 0.9rem;"></div>
            </div>

            <div id="animalsList" class="pastures-container">
                <!-- Animals will be displayed here -->
            </div>
        </div>
        
        <!-- Map Tab -->
<div id="mapTab" class="tab-content">
    <div class="action-buttons">
        <button class="btn btn-success" onclick="startGPSBoundaryCapture()">üìç RECORD FIELD BOUNDARY</button>
        <button class="btn btn-primary" id="editAreasBtn" onclick="toggleEditMode()">‚úèÔ∏è EDIT AREAS</button>
        <button class="btn btn-secondary" onclick="addNewArea()">‚ûï ADD AREA</button>
        <button class="btn btn-secondary" onclick="addNewLine()">üìè ADD LINE</button>
        <button class="btn btn-secondary" onclick="viewShredHistory()">üìä VIEW HISTORY</button>
    </div>
    
    <div id="edit-mode-status" class="hidden" style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center;">
        <h3 style="color: #856404; margin: 0;">‚úèÔ∏è EDIT MODE - Click areas to modify</h3>
    </div>
    
    <div id="ranch-map-container" style="width: 100%; height: 400px; position: relative; border-radius: 15px; overflow: hidden; background: #90EE90; border: 2px solid #228B22;">
        <div id="shredding-areas"></div>
    </div>
    
    <div id="area-summary" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
        <h4>üåæ Shredding Areas</h4>
        <div id="area-stats">No areas defined yet</div>
    </div>
</div>

<!-- Weed Tab -->
    <div id="weedTab" class="tab-content">
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="viewCurrentAlerts()">üö® Current Alerts</button>
            <button class="btn btn-secondary" onclick="viewSpeciesGuide()">üìö Species Guide</button>
            <button class="btn btn-secondary" onclick="viewCalendar()">üìÖ Calendar</button>
            <button class="btn btn-secondary" onclick="sprayCalculator()">üß™ Calculator</button>
        </div>
        
        <div id="weedContent">
            <div class="weather-card">
                <h3>üåø Central Texas Weed Management</h3>
                <p style="color: #666; margin: 1rem 0;">
                    Comprehensive weed identification, timing, and control strategies for your ranch.
                </p>
                
                <div id="currentAlerts" style="background: #fff3cd; padding: 1rem; border-radius: 10px; margin: 1rem 0;">
                    <h4 style="color: #856404; margin: 0 0 0.5rem 0;">üìÖ This Month's Priorities</h4>
                    <div id="monthlyAlerts">Loading current recommendations...</div>
                </div>
                
                <div id="sprayConditions" style="background: #e3f2fd; padding: 1rem; border-radius: 10px; margin: 1rem 0;">
                    <h4 style="color: #1976d2; margin: 0 0 0.5rem 0;">üå§Ô∏è Spray Conditions</h4>
                    <div id="conditionsContent">Checking weather conditions...</div>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Projects Tab -->
    <div id="projectsTab" class="tab-content">
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="addProject()">üîß Add Project</button>
            <button class="btn btn-secondary" onclick="viewMaterials()">üìã Materials</button>
            <button class="btn btn-secondary" onclick="projectReports()">üìä Reports</button>
            <button class="btn btn-secondary" onclick="backupData()">üíæ Backup</button>
            <input type="file" id="restoreInput" accept=".json" style="display: none;" onchange="restoreData()">
            <button class="btn btn-secondary" onclick="document.getElementById('restoreInput').click()">üìÅ Restore</button>
        </div>
             
        <div id="projectsList" class="pastures-container">
            <!-- Projects will be displayed here -->
        </div>
    </div>
    
    <!-- Photo Modal -->
    <div id="photoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Log Pasture Photo</h3>
            <input type="file" id="cameraInput" accept="image/jpeg,image/png" capture="environment">
            <div class="form-group">
                <label for="photoPasture">Pasture:</label>
                <select id="photoPasture">
                    <option value="">Select a pasture...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="photoLocation">Specific Location:</label>
                <input type="text" id="photoLocation" placeholder="e.g., Near gate, West fence line">
            </div>
            <div class="form-group">
                <label for="photoNotes">Notes:</label>
                <textarea id="photoNotes" rows="3" placeholder="e.g., Broadleaf weeds getting tall, need to shred soon"></textarea>
            </div>
            <button class="btn btn-primary" onclick="savePhoto()">Save Photo</button>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Add Note</h3>
            <div class="form-group">
                <label for="notePasture">Pasture:</label>
                <select id="notePasture">
                    <option value="">Select a pasture...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="noteLocation">Specific Location:</label>
                <input type="text" id="noteLocation" placeholder="e.g., Near gate, West fence line">
            </div>
            <div class="form-group">
                <label for="noteContent">Note:</label>
                <textarea id="noteContent" rows="4" placeholder="e.g., Shredded back pasture today, broadleaf weeds were 12 inches tall"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveNote()">Save Note</button>
        </div>
    </div>

    <!-- Pasture Management Modal -->
    <div id="pastureModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="pastureModalTitle">Add New Pasture</h3>
            <div class="form-group">
                <label for="pastureName">Pasture Name:</label>
                <input type="text" id="pastureName" placeholder="e.g., Back 40, Front Field, South Pasture">
            </div>
            <div class="form-group">
                <label for="pastureAcres">Approximate Acres:</label>
                <input type="number" id="pastureAcres" placeholder="e.g., 25" step="0.1" min="0">
            </div>
            <div class="form-group">
                <label for="pastureNotes">Description/Notes:</label>
                <textarea id="pastureNotes" rows="2" placeholder="e.g., Main grazing area, tends to get wet in low spots"></textarea>
            </div>
            <input type="hidden" id="pastureEditId">
            <button class="btn btn-primary" onclick="savePasture()">Save Pasture</button>
            <button class="btn btn-secondary" id="deletePastureBtn" onclick="deletePasture()" style="display: none;">Delete Pasture</button>
        </div>
    </div>

    <!-- Photo Assignment Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Assign Photo to Pasture</h3>
            <div class="form-group">
                <label for="assignPasture">Select Pasture:</label>
                <select id="assignPasture">
                    <option value="">Choose a pasture...</option>
                </select>
            </div>
            <input type="hidden" id="assignPhotoId">
            <button class="btn btn-primary" onclick="assignPhotoToPasture()">Assign Photo</button>
        </div>
    </div>

    <!-- Animal Modal -->
    <div id="animalModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Add New Animal</h3>
            <div class="form-group">
                <label for="animalName">Animal Name:</label>
                <input type="text" id="animalName" placeholder="e.g., Bessie, Thunder, Henrietta">
            </div>
            <div class="form-group">
                <label for="animalType">Animal Type:</label>
                <select id="animalType" onchange="updateAnimalForm()">
                    <option value="">Select type...</option>
                    <option value="cattle">üêÑ Cattle</option>
                    <option value="horses">üê¥ Horses</option>
                    <option value="chickens">üêì Chickens</option>
                    <option value="dogs">üêï Dogs</option>
                </select>
            </div>
            
            <!-- Dynamic fields that appear based on animal type -->
            <div id="dynamicFields"></div>
            
            <button class="btn btn-primary" onclick="saveAnimal()">Save Animal</button>
        </div>
    </div>

    <!-- Treatment Modal -->
    <div id="treatmentModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Add Treatment</h3>
            <div class="form-group">
                <label for="treatmentAnimal">Animal:</label>
                <select id="treatmentAnimal">
                    <option value="">Select animal...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="treatmentType">Treatment Type:</label>
                <input type="text" id="treatmentType" placeholder="e.g., Vaccination, Deworming, Antibiotic">
            </div>
            <div class="form-group">
                <label for="treatmentDate">Date Administered:</label>
                <input type="date" id="treatmentDate">
            </div>
            <div class="form-group">
                <label for="treatmentRedose">Redose Interval:</label>
                <select id="treatmentRedose">
                    <option value="">No redose needed</option>
                    <option value="1week">1 Week</option>
                    <option value="1month">1 Month</option>
                    <option value="1quarter">3 Months (Quarter)</option>
                    <option value="6months">6 Months</option>
                    <option value="1year">1 Year (Annual)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="treatmentNotes">Notes:</label>
                <textarea id="treatmentNotes" rows="3" placeholder="e.g., 10cc injection, left side"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveTreatment()">Save Treatment</button>
        </div>
    </div>

    <!-- GPS Boundary Capture Modal -->
    <div id="gpsBoundaryModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="stopGPSRecording()">&times;</span>
            <h3>üìç Record Field Boundary</h3>

            <div class="form-group">
                <label for="gpsBoundaryName">Field/Pasture Name:</label>
                <input type="text" id="gpsBoundaryName" placeholder="e.g., North Pasture, South Field">
            </div>

            <div id="gpsInstructions" style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <h4 style="margin: 0 0 0.5rem 0; color: #1976d2;">üì± Instructions</h4>
                <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">
                    1. Enter a name for this field<br>
                    2. Click "Start Recording"<br>
                    3. Walk or drive around the perimeter<br>
                    4. GPS points will be captured automatically every 5 seconds<br>
                    5. Click "Stop & Save" when you return to the start
                </p>
            </div>

            <div id="gpsStatus" class="hidden" style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <h4 style="margin: 0 0 0.5rem 0; color: #856404;">üéØ Recording Status</h4>
                <div style="font-size: 0.9rem;">
                    <div><strong>Points Captured:</strong> <span id="gpsPointCount">0</span></div>
                    <div><strong>GPS Accuracy:</strong> <span id="gpsAccuracy">--</span> meters</div>
                    <div><strong>Last Update:</strong> <span id="gpsLastUpdate">--</span></div>
                </div>
            </div>

            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-success" id="gpsStartBtn" onclick="startGPSRecording()">‚ñ∂Ô∏è Start Recording</button>
                <button class="btn btn-danger hidden" id="gpsStopBtn" onclick="finishGPSRecording()">‚èπÔ∏è Stop & Save</button>
                <button class="btn btn-secondary hidden" id="gpsPauseBtn" onclick="pauseGPSRecording()">‚è∏Ô∏è Pause</button>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Add New Project</h3>
            <div class="form-group">
                <label for="projectName">Project Name:</label>
                <input type="text" id="projectName" placeholder="e.g., Fix South Fence, Barn Roof Repair">
            </div>
            <div class="form-group">
                <label for="projectPriority">Priority:</label>
                <select id="projectPriority">
                    <option value="low">üü¢ Low</option>
                    <option value="medium">üü° Medium</option>
                    <option value="high">üî¥ High</option>
                    <option value="urgent">üö® Urgent</option>
                </select>
            </div>
            <div class="form-group">
                <label for="projectDueDate">Target Completion:</label>
                <input type="date" id="projectDueDate">
            </div>
            <div class="form-group">
                <label for="projectDescription">Description:</label>
                <textarea id="projectDescription" rows="3" placeholder="e.g., Replace broken fence posts and wire on south boundary"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveProject()">Save Project</button>
        </div>
    </div>

<!-- Materials Modal -->
<div id="materialsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="materialsModalTitle">Add Material</h3>
        <div class="form-group">
            <label for="materialProject">Project:</label>
            <select id="materialProject">
                <option value="">Select project...</option>
            </select>
        </div>
        <div class="form-group">
            <label for="materialName">Material Name:</label>
            <input type="text" id="materialName" placeholder="e.g., 2x4 lumber, fence posts, screws">
        </div>
        <div class="form-group">
            <label for="materialCategory">Category:</label>
            <select id="materialCategory">
                <option value="lumber">ü™µ Lumber</option>
                <option value="hardware">üî© Hardware</option>
                <option value="tools">üî® Tools</option>
                <option value="concrete">üß± Concrete/Masonry</option>
                <option value="paint">üé® Paint/Finish</option>
                <option value="electrical">‚ö° Electrical</option>
                <option value="other">üì¶ Other</option>
            </select>
        </div>
        <div class="form-group">
            <label for="materialQuantityNeeded">Quantity Needed:</label>
            <input type="number" id="materialQuantityNeeded" placeholder="e.g., 10" step="0.1" min="0">
        </div>
        <div class="form-group">
            <label for="materialUnit">Unit:</label>
            <input type="text" id="materialUnit" placeholder="e.g., pieces, feet, bags, gallons">
        </div>
        <div class="form-group">
            <label for="materialEstimatedCost">Estimated Cost ($):</label>
            <input type="number" id="materialEstimatedCost" placeholder="e.g., 25.99" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="materialNotes">Notes:</label>
            <textarea id="materialNotes" rows="2" placeholder="e.g., Get from Home Depot, pressure treated"></textarea>
        </div>
        <input type="hidden" id="materialEditId">
        <button class="btn btn-primary" onclick="saveMaterial()">Save Material</button>
    </div>
</div>

<!-- Mark Material Obtained Modal -->
<div id="obtainedModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>Mark Material as Obtained</h3>
        <div class="form-group">
            <label for="obtainedQuantity">Quantity Obtained:</label>
            <input type="number" id="obtainedQuantity" step="0.1" min="0">
        </div>
        <div class="form-group">
            <label for="actualCost">Actual Cost ($):</label>
            <input type="number" id="actualCost" step="0.01" min="0">
        </div>
        <input type="hidden" id="obtainedMaterialId">
        <button class="btn btn-primary" onclick="markMaterialObtained()">Mark as Obtained</button>
    </div>
</div>


<!-- Spray Calculator Modal -->
<div id="calculatorModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>üß™ Spray Mix Calculator</h3>
        
        <div class="calc-inputs">
            <div class="form-group">
                <label for="tankSize">Spray Tank Size (gallons):</label>
                <select id="tankSize" onchange="calculateSprayMix()">
                    <option value="15">15 gallon</option>
                    <option value="25" selected>25 gallon</option>
                    <option value="40">40 gallon</option>
                    <option value="60">60 gallon</option>
                    <option value="100">100 gallon</option>
                    <option value="200">200 gallon</option>
                    <option value="300">300 gallon</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="acreage">Acres to Spray:</label>
                <input type="number" id="acreage" value="10" step="0.1" min="0.1" onchange="calculateSprayMix()">
            </div>
            
            <div class="form-group">
                <label for="herbicide">Herbicide:</label>
                <select id="herbicide" onchange="calculateSprayMix()">
                    <option value="2,4-D">2,4-D LV Ester</option>
                    <option value="Grazon P+D">Grazon P+D</option>
                    <option value="Dicamba">Dicamba (tank mix)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="weedTarget">Primary Target Weed:</label>
                <select id="weedTarget" onchange="calculateSprayMix()">
                    <option value="general">General Broadleaf</option>
                    <option value="wooly-croton">Wooly Croton</option>
                    <option value="dogfennel">Dogfennel</option>
                    <option value="sesbania">Sesbania</option>
                    <option value="thistle">Bull Thistle</option>
                    <option value="ragweed">Giant Ragweed</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="surfactant" onchange="calculateSprayMix()"> 
                    Add Non-Ionic Surfactant (NIS)
                </label>
                <small style="color: #666; display: block; margin-top: 0.25rem;">Improves herbicide penetration</small>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="blueDye" onchange="calculateSprayMix()"> 
                    Add Blue Dye Marker
                </label>
                <small style="color: #666; display: block; margin-top: 0.25rem;">Track coverage and avoid overlap</small>
            </div>
        </div>
        
        <div id="calculatorResults">
            <!-- Results will be populated here -->
        </div>
    </div>
</div>

    
<!-- Species Guide Modal -->
<div id="speciesModal" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>üìö Central Texas Weed Species Guide</h3>
        <div id="speciesContainer"></div>
        <div id="speciesDetail" style="display: none;"></div>
    </div>
</div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Confirm Deletion</h3>
            <p id="deleteConfirmMessage"></p>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-delete" id="confirmDeleteBtn" style="background: #dc3545; color: white;">Delete</button>
            </div>
        </div>
    </div>

<!-- Edit Line Modal -->
<div id="editLineModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>‚úèÔ∏è Edit Line</h3>
        
        <div class="form-group">
            <label for="editLineName">Line Name:</label>
            <input type="text" id="editLineName" placeholder="e.g., Front Fence, Main Driveway">
        </div>
        
        <div class="form-group">
            <label for="editLineType">Line Type:</label>
            <select id="editLineType">
                <option value="property">üî¥ Property Boundary</option>
                <option value="fence">‚ö´ Fence Line</option>
                <option value="driveway">üü£ Driveway</option>
                <option value="reference">‚ö™ Reference Line</option>
                <option value="water">üîµ Water Line</option>
                <option value="power">üü° Power Line</option>
                <option value="gas">üü§ Gas Line</option>
                <option value="irrigation">üü† Irrigation</option>
                <option value="septic">‚ö™ Septic/Sewer</option>
                <option value="easement">üü¢ Easement</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="editLineDirection">Direction:</label>
            <select id="editLineDirection">
                <option value="horizontal">‚ÜîÔ∏è Horizontal</option>
                <option value="vertical">‚ÜïÔ∏è Vertical</option>
                <option value="diagonal-ne">‚ÜóÔ∏è Diagonal NE</option>
                <option value="diagonal-nw">‚ÜñÔ∏è Diagonal NW</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="editLineLength">Length:</label>
            <select id="editLineLength">
                <option value="short">Short (50ft)</option>
                <option value="medium">Medium (100ft)</option>
                <option value="long">Long (200ft)</option>
                <option value="extralong">Extra Long (300ft)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="editLineStyle">Line Style:</label>
            <select id="editLineStyle">
                <option value="solid">‚îÅ‚îÅ‚îÅ Solid</option>
                <option value="dashed">‚îÖ‚îÖ‚îÖ Dashed (Utilities)</option>
            </select>
        </div>
        
        <input type="hidden" id="editLineId">
        
        <div class="edit-actions" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="saveLineEdits()">üíæ Save</button>
            <button class="btn btn-secondary" onclick="startMoveLine()">üìç Move</button>
            <button class="btn btn-delete" onclick="confirmDeleteLine()" style="background: #dc3545; color: white;">üóëÔ∏è Delete</button>
        </div>
    </div>
</div>
    
<!-- Line Creation Modal -->
<div id="lineModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="lineModalTitle">Create New Line</h3>
        
        <div class="form-group">
            <label for="lineName">Line Name (optional):</label>
            <input type="text" id="lineName" placeholder="e.g., Front Fence, Main Driveway">
        </div>
        
        <div class="form-group">
            <label for="lineType">Line Type:</label>
            <select id="lineType">
                <option value="property">üî¥ Property Boundary</option>
                <option value="fence" selected>‚ö´ Fence Line</option>
                <option value="driveway">üü£ Driveway</option>
                <option value="reference">‚ö™ Reference Line</option>
                <option value="water">üîµ Water Line</option>
                <option value="power">üü° Power Line</option>
                <option value="gas">üü§ Gas Line</option>
                <option value="irrigation">üü† Irrigation</option>
                <option value="septic">‚ö™ Septic/Sewer</option>
                <option value="easement">üü¢ Easement</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="lineDirection">Direction:</label>
            <select id="lineDirection">
                <option value="horizontal">‚ÜîÔ∏è Horizontal</option>
                <option value="vertical">‚ÜïÔ∏è Vertical</option>
                <option value="diagonal-ne">‚ÜóÔ∏è Diagonal NE</option>
                <option value="diagonal-nw">‚ÜñÔ∏è Diagonal NW</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="lineLength">Length:</label>
            <select id="lineLength">
                <option value="short">Short (50ft)</option>
                <option value="medium" selected>Medium (100ft)</option>
                <option value="long">Long (200ft)</option>
                <option value="extralong">Extra Long (300ft)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="lineStyle">Line Style:</label>
            <select id="lineStyle">
                <option value="solid" selected>‚îÅ‚îÅ‚îÅ Solid</option>
                <option value="dashed">‚îÖ‚îÖ‚îÖ Dashed (Utilities)</option>
            </select>
        </div>
        
        <input type="hidden" id="lineEditId">
        <button class="btn btn-primary" onclick="createLine()">Create Line</button>
        <button class="btn btn-secondary" id="deleteLineBtn" onclick="confirmDeleteLine()" style="display: none;">Delete Line</button>
    </div>
</div>
    
<!-- Resize Area Modal -->
<div id="resizeAreaModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>üîÑ Resize Area</h3>
        
        <div style="text-align: center; margin: 1rem 0;">
            <strong>Resizing: <span id="resizeAreaName"></span></strong>
        </div>
        
        <div class="form-group">
            <label for="resizeAreaSize">New Size:</label>
            <select id="resizeAreaSize">
                <option value="tiny">Tiny (1-2 acres)</option>
                <option value="small">Small (2-5 acres)</option>
                <option value="medium">Medium (5-15 acres)</option>
                <option value="large">Large (15-25 acres)</option>
                <option value="huge">Huge (25+ acres)</option>
            </select>
        </div>
        
        <input type="hidden" id="resizeAreaId">
        <button class="btn btn-primary" onclick="confirmResize()">‚úÖ Resize Area</button>
    </div>
</div>
    

<!-- Edit Area Modal -->
<div id="editAreaModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>‚úèÔ∏è Edit Shredding Area</h3>
        
        <div class="form-group">
            <label for="editAreaName">Area Name:</label>
            <input type="text" id="editAreaName" placeholder="e.g., Back 40, Creek Bottom">
        </div>
        
        <input type="hidden" id="editAreaId">
        
        <div class="edit-actions" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-top: 1.5rem;">
    <button class="btn btn-primary" onclick="editAreaProperties()">üíæ Save Name</button>
    <button class="btn btn-secondary" onclick="startMoveArea()">üìç Move Position</button>
    <button class="btn btn-secondary" onclick="startResizeArea()">üîÑ Resize</button>
</div>
        
        <div style="margin-top: 1rem; text-align: center;">
            <button class="btn btn-delete" onclick="confirmDeleteEditArea()" style="background: #dc3545; color: white;">üóëÔ∏è Delete Area</button>
        </div>
    </div>
</div>
    
<!-- Shredding Area Modal -->
<div id="areaModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="areaModalTitle">Create New Shredding Area</h3>
        
        <div class="form-group">
            <label for="areaName">Area Name:</label>
            <input type="text" id="areaName" placeholder="e.g., Back 40, Creek Bottom, Front Pasture">
        </div>
        
        <div class="form-group">
            <label for="areaShape">Shape Type:</label>
            <select id="areaShape">
                <option value="rectangle">üìê Rectangle</option>
                <option value="circle">‚≠ï Circle</option>
                <option value="polygon">üìç Custom Shape (Click Points)</option>
            </select>
        </div>
        
        <div class="form-group">
    <label for="areaShape">Shape Type:</label>
    <select id="areaShape">
        <option value="rectangle">üìê Rectangle</option>
        <option value="circle">‚≠ï Circle</option>
        <option value="oval">ü•ö Oval</option>
        <option value="square">‚¨ú Square</option>
    </select>
</div>

<div class="form-group">
    <label for="areaSize">Size:</label>
    <select id="areaSize">
        <option value="tiny">Tiny (1-2 acres)</option>
        <option value="small">Small (2-5 acres)</option>
        <option value="medium" selected>Medium (5-15 acres)</option>
        <option value="large">Large (15-25 acres)</option>
        <option value="huge">Huge (25+ acres)</option>
    </select>
</div>
        
        <div id="instructionText" style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin: 1rem 0; font-size: 0.9rem;">
            After creating, click anywhere on the map to position this area.
        </div>
        
        <input type="hidden" id="areaEditId">
        <button class="btn btn-primary" onclick="createArea()">Create Area</button>
        <button class="btn btn-secondary" id="deleteAreaBtn" onclick="confirmDeleteArea()" style="display: none;">Delete Area</button>
    </div>
</div>

<!-- Shredding Confirmation Modal -->
<div id="shreddingModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
<h3>üåæ Area Management</h3>
        
        <div style="text-align: center; margin: 1rem 0;">
            <div style="font-size: 1.2rem; font-weight: bold; color: #228B22;" id="shreddingAreaName"></div>
            <div style="color: #666; margin-top: 0.5rem;" id="shreddingAreaStatus"></div>
        </div>
        
        <div class="form-group">
            <label for="shreddingDate">Date Shredded:</label>
            <input type="date" id="shreddingDate">
        </div>
        
        <div class="form-group">
            <label for="shreddingNotes">Notes (optional):</label>
            <textarea id="shreddingNotes" rows="2" placeholder="e.g., Cut to 6 inches, conditions were perfect"></textarea>
        </div>
        
        <input type="hidden" id="shreddingAreaId">
        <button class="btn btn-primary" onclick="confirmShredding()">‚úÖ Mark as Shredded</button>
<button class="btn btn-secondary" onclick="confirmSpraying()" style="background: #007bff; color: white; margin-left: 0.5rem;">üß™ Mark as Sprayed</button>
        <button class="btn btn-secondary" onclick="viewAreaHistory()">üìÖ View History</button>
    </div>
</div>
        
    <!-- Full Screen Photo Modal -->
    <div id="photoViewModal" class="photo-modal">
        <span class="photo-modal-close" onclick="closePhotoView()">&times;</span>
        <img id="photoViewImage" src="" alt="Full size photo">
        <div id="photoViewInfo" class="photo-modal-info"></div>
    </div>

    <script>
        // Constants
        const WEATHER_API_KEY = '7ab1a33cdc7b4293b4e05f99544978fa';
        const LAT = 29.8669;
        const LON = -96.8767;
        
        // Global variables
let currentWeather = null;
let photos = JSON.parse(localStorage.getItem('pasturePhotos') || '[]');
let notes = JSON.parse(localStorage.getItem('pastureNotes') || '[]');
let pastures = JSON.parse(localStorage.getItem('pastures') || '[]');
let animals = JSON.parse(localStorage.getItem('animals') || '[]');
let burnBanStatus = JSON.parse(localStorage.getItem('burnBanStatus') || '{"fayette": {"active": false, "expires": ""}}');
let treatments = JSON.parse(localStorage.getItem('treatments') || '[]');
let currentAnimalFilter = 'all';

// CUSTOM SHREDDING AREA VARIABLES
let shreddingAreas = JSON.parse(localStorage.getItem('shreddingAreas') || '[]');
let fieldBoundaries = JSON.parse(localStorage.getItem('fieldBoundaries') || '[]');
let ranchLines = JSON.parse(localStorage.getItem('ranchLines') || '[]');let isEditMode = false;
let selectedArea = null;
     
        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
    initializeBurnBanControls();
    displayPastures();
    displayAnimals();
    displayProjects();
    requestNotificationPermission();
    loadWeather();
    initializeOfflineMode();
    
    initializeCustomShredMap();
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('data:text/javascript,console.log("SW registered")');
    }
});
        
        // Burn ban functions
        function initializeBurnBanControls() {
            updateBurnBanDisplay('fayette');
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeBurnBanControls();
            displayPastures();
            displayAnimals();
            displayProjects();
            requestNotificationPermission();
            loadWeather();
            initializeOfflineMode();
            
            initializeMap();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript,console.log("SW registered")');
            }
        });
        
        // Burn ban functions
        function initializeBurnBanControls() {
            updateBurnBanDisplay('fayette');
        }
        
        function toggleBurnBan(county) {
            burnBanStatus[county].active = !burnBanStatus[county].active;
            if (!burnBanStatus[county].active) {
                burnBanStatus[county].expires = '';
            }
            saveBurnBanStatus();
            updateBurnBanDisplay(county);
            if (currentWeather) {
                checkFireWeather(currentWeather);
            }
        }
        
        function updateBurnBanDate(county) {
            const dateInput = document.getElementById(county + 'Date');
            const selectedDate = dateInput.value;

            // Validate date is not in the past
            const today = new Date().toISOString().split('T')[0];
            if (selectedDate && selectedDate < today) {
                alert('Burn ban expiry date cannot be in the past. Please select today or a future date.');
                dateInput.value = burnBanStatus[county].expires || '';
                return;
            }

            burnBanStatus[county].expires = selectedDate;
            saveBurnBanStatus();
        }
        
        function updateBurnBanDisplay(county) {
            const toggle = document.getElementById(county + 'Toggle');
            const status = document.getElementById(county + 'Status');
            const expiryDiv = document.getElementById(county + 'Expiry');
            const dateInput = document.getElementById(county + 'Date');
            
            if (burnBanStatus[county].active) {
                toggle.classList.add('active');
                status.textContent = 'ACTIVE';
                status.style.color = '#dc3545';
                status.style.fontWeight = 'bold';
                expiryDiv.classList.remove('hidden');
                dateInput.value = burnBanStatus[county].expires || '';
            } else {
                toggle.classList.remove('active');
                status.textContent = 'OFF';
                status.style.color = '#28a745';
                status.style.fontWeight = 'normal';
                expiryDiv.classList.add('hidden');
            }
        }
        
        function saveBurnBanStatus() {
            localStorage.setItem('burnBanStatus', JSON.stringify(burnBanStatus));
        }
        
        function checkBurnBanExpiry() {
            const today = new Date().toISOString().split('T')[0];
            let updated = false;
            
            if (burnBanStatus.fayette.active && burnBanStatus.fayette.expires && burnBanStatus.fayette.expires < today) {
                burnBanStatus.fayette.active = false;
                burnBanStatus.fayette.expires = '';
                updated = true;
            }
            
            if (updated) {
                saveBurnBanStatus();
                initializeBurnBanControls();
                if (currentWeather) {
                    checkFireWeather(currentWeather);
                }
            }
        }
        
        function checkBurnBanStatus() {
            checkBurnBanExpiry();
            
            if (burnBanStatus.fayette.active) {
                let message = "FAYETTE COUNTY BURN BAN - No outdoor burning permitted";
                if (burnBanStatus.fayette.expires) {
                    const expireDate = new Date(burnBanStatus.fayette.expires).toLocaleDateString();
                    message += ` (expires ${expireDate})`;
                }
                
                return {
                    active: true,
                    message: message,
                    source: "Update status above after checking county website"
                };
            }
            
            return {
                active: false,
                message: "No Fayette County burn ban currently active",
                source: "Check county website to verify and update toggle above"
            };
        }
        
        // Weather functions
        function getWeatherIcon(condition) {
            const conditionLower = condition.toLowerCase();
            
            if (conditionLower.includes('clear') || conditionLower.includes('sunny')) return '‚òÄÔ∏è';
            if (conditionLower.includes('partly') || conditionLower.includes('few clouds')) return '‚õÖ';
            if (conditionLower.includes('scattered clouds') || conditionLower.includes('broken clouds')) return '‚òÅÔ∏è';
            if (conditionLower.includes('overcast') || conditionLower.includes('cloudy')) return '‚òÅÔ∏è';
            if (conditionLower.includes('rain') || conditionLower.includes('drizzle')) return 'üåßÔ∏è';
            if (conditionLower.includes('thunder') || conditionLower.includes('storm')) return '‚õàÔ∏è';
            if (conditionLower.includes('snow')) return '‚ùÑÔ∏è';
            if (conditionLower.includes('mist') || conditionLower.includes('fog')) return 'üå´Ô∏è';
            if (conditionLower.includes('hot')) return 'üî•';
            if (conditionLower.includes('humid')) return 'üíß';
            if (conditionLower.includes('wind')) return 'üí®';
            
            return 'üå§Ô∏è';
        }
        
        function getWeatherBackground(condition, temp) {
            if (condition.includes('Rain') || condition.includes('Thunder')) {
                return 'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)';
            } else if (temp > 95) {
                return 'linear-gradient(135deg, #fd79a8 0%, #e84393 100%)';
            } else if (condition === 'Sunny') {
                return 'linear-gradient(135deg, #fdcb6e 0%, #e17055 100%)';
            } else if (condition.includes('Cloudy')) {
                return 'linear-gradient(135deg, #ddd 0%, #bbb 100%)';
            } else {
                return 'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)';
            }
        }
        
        function capitalizeCondition(description) {
            return description.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        
        async function loadWeather() {
            try {
                console.log('Attempting to fetch weather data...');
                
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const currentUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&appid=${WEATHER_API_KEY}&units=imperial`;
                const hourlyUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${LAT}&lon=${LON}&appid=${WEATHER_API_KEY}&units=imperial`;
                
                let currentResponse, hourlyResponse;
                
                try {
                    currentResponse = await fetch(currentUrl);
                    hourlyResponse = await fetch(hourlyUrl);
                } catch (corsError) {
                    console.log('Direct API failed, trying CORS proxy...');
                    currentResponse = await fetch(proxyUrl + encodeURIComponent(currentUrl));
                    hourlyResponse = await fetch(proxyUrl + encodeURIComponent(hourlyUrl));
                }
                
                if (!currentResponse.ok) {
                    throw new Error(`HTTP ${currentResponse.status}: ${currentResponse.statusText}`);
                }
                
                const currentData = await currentResponse.json();
                const hourlyData = await hourlyResponse.json();
                
                console.log('Weather data received:', currentData);
                
                const realWeather = {
                    temp: Math.round(currentData.main.temp),
                    condition: capitalizeCondition(currentData.weather[0].description),
                    humidity: currentData.main.humidity,
                    windSpeed: Math.round(currentData.wind.speed),
                    precipitation: currentData.rain ? (currentData.rain['1h'] || 0) : 0,
                    uvIndex: 8,
                    nextHourRain: hourlyData.list[0].rain ? (hourlyData.list[0].rain['3h'] || 0) / 3 : 0,
                    rainProbability: Math.round(hourlyData.list[0].pop * 100),
                    forecastData: hourlyData.list.slice(0, 7)
                };
                
                currentWeather = realWeather;
                displayWeather(realWeather);
                checkAlerts(realWeather);
                checkFireWeather(realWeather);
                checkBurnBanExpiry();
                
                console.log('Real weather data loaded successfully!');
                
            } catch (error) {
                console.error('Weather API error:', error);
                
                document.getElementById('weatherContent').innerHTML = `
                    <div style="text-align: center; padding: 1rem; background: #fff3cd; border-radius: 10px; margin-bottom: 1rem;">
                        <p><strong>‚ö†Ô∏è Using Sample Data</strong></p>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
                            API connection issue - showing realistic sample data for now.<br>
                            <em>Will retry in 30 minutes...</em>
                        </p>
                    </div>
                `;
                
                setTimeout(() => {
                    loadMockWeather();
                }, 2000);
            }
        }
        
        function loadMockWeather() {
            const conditions = ['Sunny', 'Partly Cloudy', 'Hot', 'Humid'];
            const condition = conditions[Math.floor(Math.random() * conditions.length)];
            
            const mockWeather = {
                temp: Math.round(75 + Math.random() * 25),
                condition: condition,
                humidity: Math.round(45 + Math.random() * 35),
                windSpeed: Math.round(5 + Math.random() * 10),
                precipitation: Math.round(Math.random() * 100) / 100,
                uvIndex: Math.round(6 + Math.random() * 5),
                nextHourRain: Math.round(Math.random() * 20) / 100,
                rainProbability: Math.round(Math.random() * 100)
            };
            
            currentWeather = mockWeather;
            displayWeather(mockWeather);
            checkAlerts(mockWeather);
            checkFireWeather(mockWeather);
            checkBurnBanExpiry();
        }
        
        function displayWeather(weather) {
            const weatherIcon = getWeatherIcon(weather.condition);
            const backgroundGradient = getWeatherBackground(weather.condition, weather.temp);
            
            const weatherHtml = `
                <div class="current-weather">
                    <div class="weather-background" style="background: ${backgroundGradient}"></div>
                    <div class="weather-icon">${weatherIcon}</div>
                    <div class="temp">${weather.temp}¬∞F</div>
                    <div class="conditions">${weather.condition}</div>
                    <div class="weather-details">
                        <div class="detail-item">
                            <div class="detail-label">Humidity</div>
                            <div class="detail-value">${weather.humidity}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Wind</div>
                            <div class="detail-value">${weather.windSpeed} mph</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Rain (24h)</div>
                            <div class="detail-value">${weather.precipitation}"</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">UV Index</div>
                            <div class="detail-value">${weather.uvIndex}</div>
                        </div>
                    </div>
                </div>
                <div class="hourly-rain">
                    <div class="rain-title">‚òî Next Hour Forecast</div>
                    <div class="rain-amount">${weather.nextHourRain}" expected</div>
                    <div class="rain-prob">${weather.rainProbability}% chance of rain</div>
                </div>
                <div class="forecast">
                    ${generateForecast()}
                </div>
            `;
            
            document.getElementById('weatherContent').innerHTML = weatherHtml;
        }
        
        function generateForecast() {
            if (currentWeather && currentWeather.forecastData) {
                return generateRealForecast(currentWeather.forecastData);
            }
            
            const days = ['Today', 'Tomorrow', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const conditions = ['Sunny', 'Partly Cloudy', 'Hot', 'Cloudy', 'Humid'];
            const peakTimes = ['2:15 PM', '2:30 PM', '3:00 PM', '2:45 PM', '3:15 PM', '2:20 PM', '3:30 PM'];
            
            let html = '';
            
            for (let i = 0; i < 7; i++) {
                const baseTemp = 85 + Math.random() * 15;
                const high = Math.round(baseTemp);
                const low = Math.round(baseTemp - 15 - Math.random() * 10);
                
                const condition = conditions[Math.floor(Math.random() * conditions.length)];
                const icon = getWeatherIcon(condition);
                const peakTime = peakTimes[i];
                
                html += `
                    <div class="forecast-day">
                        <div class="forecast-date">${days[i]}</div>
                        <div class="forecast-icon">${icon}</div>
                        <div class="forecast-temps">
                            <span class="forecast-high">${high}¬∞</span>
                            <span class="forecast-low">/${low}¬∞</span>
                        </div>
                        <div class="forecast-peak-time">Peak: ${peakTime}</div>
                        <div class="forecast-desc">${condition}</div>
                    </div>
                `;
            }
            
            return html;
        }
        
        function generateRealForecast(forecastData) {
            const days = ['Today', 'Tomorrow', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            let html = '';
            
            const dailyData = {};
            forecastData.forEach(item => {
                const date = new Date(item.dt * 1000);
                const dayKey = date.toDateString();
                
                if (!dailyData[dayKey]) {
                    dailyData[dayKey] = {
                        temps: [],
                        conditions: [],
                        times: []
                    };
                }
                
                dailyData[dayKey].temps.push(item.main.temp);
                dailyData[dayKey].conditions.push(item.weather[0].description);
                dailyData[dayKey].times.push(date.getHours());
            });
            
            const dayKeys = Object.keys(dailyData).slice(0, 7);
            
            for (let i = 0; i < Math.min(7, dayKeys.length); i++) {
                const dayData = dailyData[dayKeys[i]];
                const high = Math.round(Math.max(...dayData.temps));
                const low = Math.round(Math.min(...dayData.temps));
                
                const peakTime = ['2:15 PM', '2:30 PM', '3:00 PM', '2:45 PM', '3:15 PM', '2:20 PM', '3:30 PM'][i % 7];
                
                const condition = capitalizeCondition(dayData.conditions[0]);
                const icon = getWeatherIcon(condition);
                
                html += `
                    <div class="forecast-day">
                        <div class="forecast-date">${days[i] || 'Day ' + (i+1)}</div>
                        <div class="forecast-icon">${icon}</div>
                        <div class="forecast-temps">
                            <span class="forecast-high">${high}¬∞</span>
                            <span class="forecast-low">/${low}¬∞</span>
                        </div>
                        <div class="forecast-peak-time">Peak: ${peakTime}</div>
                        <div class="forecast-desc">${condition}</div>
                    </div>
                `;
            }
            
            return html;
        }
        
        function checkFireWeather(weather) {
            let fireAlerts = [];
            let riskLevel = 'LOW';
            let alertClass = 'fire-alert';
            let riskClass = 'risk-low';
            
            let riskFactors = 0;
            
            if (weather.windSpeed >= 25) {
                riskFactors += 3;
                fireAlerts.push("üå™Ô∏è EXTREME WIND: " + weather.windSpeed + " mph - No outdoor burning, high fire spread risk");
            } else if (weather.windSpeed >= 15) {
                riskFactors += 2;
                fireAlerts.push("üí® High winds: " + weather.windSpeed + " mph - Avoid outdoor burning");
            } else if (weather.windSpeed >= 10) {
                riskFactors += 1;
            }
            
            if (weather.humidity <= 15) {
                riskFactors += 3;
                fireAlerts.push("üèúÔ∏è CRITICAL HUMIDITY: " + weather.humidity + "% - Extremely dry conditions");
            } else if (weather.humidity <= 25) {
                riskFactors += 2;
                fireAlerts.push("‚òÄÔ∏è Low humidity: " + weather.humidity + "% - Increased fire risk");
            } else if (weather.humidity <= 35) {
                riskFactors += 1;
            }
            
            if (weather.temp >= 100) {
                riskFactors += 2;
                fireAlerts.push("üî• Extreme heat: " + weather.temp + "¬∞F - High fire danger");
            } else if (weather.temp >= 90) {
                riskFactors += 1;
            }
            
            if (weather.precipitation < 0.1) {
                riskFactors += 1;
                fireAlerts.push("üåµ Dry conditions: No recent rain - Vegetation is dry");
            }
            
            if (riskFactors >= 6) {
                riskLevel = 'EXTREME';
                alertClass = 'fire-alert extreme';
                riskClass = 'risk-extreme';
            } else if (riskFactors >= 4) {
                riskLevel = 'HIGH';
                alertClass = 'fire-alert high';
                riskClass = 'risk-high';
            } else if (riskFactors >= 2) {
                riskLevel = 'MODERATE';
                alertClass = 'fire-alert moderate';
                riskClass = 'risk-moderate';
            } else {
                riskLevel = 'LOW';
                alertClass = 'fire-alert';
                riskClass = 'risk-low';
            }
            
            const burnBanStatus = checkBurnBanStatus();
            if (burnBanStatus.active) {
                fireAlerts.unshift("üö´ " + burnBanStatus.message);
                if (riskLevel === 'LOW') {
                    riskLevel = 'MODERATE';
                    riskClass = 'risk-moderate';
                    alertClass = 'fire-alert moderate';
                }
            }
            
            if (riskLevel !== 'LOW') {
                fireAlerts.push("‚ö†Ô∏è Recommendations: Avoid welding, grinding, or any spark-producing activities");
                if (riskLevel === 'HIGH' || riskLevel === 'EXTREME') {
                    fireAlerts.push("üö® Keep water/fire extinguisher nearby for all outdoor work");
                }
            }
            
            document.getElementById('fireAlertContainer').className = alertClass;
            document.getElementById('fireRiskLevel').className = `risk-level ${riskClass}`;
            document.getElementById('fireRiskLevel').textContent = `üî• FIRE RISK: ${riskLevel}`;
            
            if (fireAlerts.length > 0) {
                document.getElementById('fireAlertContent').innerHTML = fireAlerts.join('<br><br>');
            } else {
                document.getElementById('fireAlertContent').innerHTML = "‚úÖ Current conditions pose minimal fire risk. Normal fire safety precautions apply.";
            }
            
            document.getElementById('fireAlertsSection').classList.remove('hidden');
        }
        
        function checkAlerts(weather) {
            let alerts = [];
            
            if (weather.temp > 95 && weather.humidity > 70) {
                alerts.push("üî• Heat stress warning - Monitor cattle closely, ensure adequate water");
            }
            
            if (weather.windSpeed < 10 && weather.temp < 95) {
                alerts.push("‚úÖ Good shredding conditions - Low wind, manageable temperature");
            }
            
            if (weather.precipitation > 0.5) {
                alerts.push("üíß Recent rain - Wait 2-3 days before shredding to avoid rutting");
            }
            
            if (weather.humidity > 80 && weather.temp > 80) {
                alerts.push("üçÑ High fungal risk - Monitor for plant diseases");
            }
            
            const month = new Date().getMonth() + 1;
            if (month >= 4 && month <= 6) {
                alerts.push("üåø Peak broadleaf season - Monitor Queen Anne's lace and thistle growth");
            }
            
            if (month >= 6 && month <= 8) {
                alerts.push("üå≥ Mesquite seed season - Check for new seedlings after rain");
            }
            
            if (alerts.length > 0) {
                document.getElementById('alertContent').innerHTML = alerts.join('<br><br>');
                document.getElementById('alertsSection').classList.remove('hidden');
            } else {
                document.getElementById('alertsSection').classList.add('hidden');
            }
        }
        
        // Tab functions
        function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // Activate selected tab button
    event.target.classList.add('active');
}
        
        // Photo functions
        function takePhoto() {
            updatePastureDropdowns();
            // Clear any previous file selection
            document.getElementById('cameraInput').value = '';
            document.getElementById('photoModal').style.display = 'block';
        }
        
        function addNote() {
            updatePastureDropdowns();
            document.getElementById('noteModal').style.display = 'block';
        }
        
        function closeModal() {
    document.getElementById('photoModal').style.display = 'none';
    document.getElementById('noteModal').style.display = 'none';
    document.getElementById('pastureModal').style.display = 'none';
    document.getElementById('assignModal').style.display = 'none';
    document.getElementById('animalModal').style.display = 'none';
    document.getElementById('treatmentModal').style.display = 'none';
    document.getElementById('deleteConfirmModal').style.display = 'none';
    document.getElementById('projectModal').style.display = 'none';
    document.getElementById('materialsModal').style.display = 'none';
    document.getElementById('obtainedModal').style.display = 'none';
    document.getElementById('areaModal').style.display = 'none';
    document.getElementById('shreddingModal').style.display = 'none';
    document.getElementById('speciesModal').style.display = 'none';
    document.getElementById('calculatorModal').style.display = 'none';
    document.getElementById('editAreaModal').style.display = 'none';
    document.getElementById('resizeAreaModal').style.display = 'none';
                       document.getElementById('editLineModal').style.display = 'none';      
    document.getElementById('lineModal').style.display = 'none';
    clearModalInputs();
    }
        
        function clearModalInputs() {
            document.getElementById('photoLocation').value = '';
            document.getElementById('photoNotes').value = '';
            document.getElementById('photoPasture').value = '';
            document.getElementById('noteLocation').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('notePasture').value = '';
            document.getElementById('cameraInput').value = '';
            document.getElementById('pastureName').value = '';
            document.getElementById('pastureAcres').value = '';
            document.getElementById('pastureNotes').value = '';
            document.getElementById('pastureEditId').value = '';
            document.getElementById('assignPasture').value = '';
            document.getElementById('assignPhotoId').value = '';
            document.getElementById('animalName').value = '';
            document.getElementById('animalType').value = '';
            document.getElementById('dynamicFields').innerHTML = '';
            document.getElementById('treatmentAnimal').value = '';
            document.getElementById('treatmentType').value = '';
            document.getElementById('treatmentDate').value = '';
            document.getElementById('treatmentRedose').value = '';
            document.getElementById('treatmentNotes').value = '';
            document.getElementById('animalModal').removeAttribute('data-edit-id');
            document.getElementById('pastureModalTitle').textContent = 'Add New Pasture';
            document.getElementById('deletePastureBtn').style.display = 'none';
document.getElementById('projectName').value = '';
document.getElementById('projectPriority').value = 'low';
document.getElementById('projectDueDate').value = '';
document.getElementById('projectDescription').value = '';
document.getElementById('projectModal').removeAttribute('data-edit-id');            
        }

        document.getElementById('materialProject').value = '';
            document.getElementById('materialName').value = '';
            document.getElementById('materialCategory').value = 'lumber';
            document.getElementById('materialQuantityNeeded').value = '';
            document.getElementById('materialUnit').value = '';
            document.getElementById('materialEstimatedCost').value = '';
            document.getElementById('materialNotes').value = '';
            document.getElementById('materialEditId').value = '';
            document.getElementById('materialsModalTitle').textContent = 'Add Material';
            document.getElementById('obtainedQuantity').value = '';
            document.getElementById('actualCost').value = '';
            document.getElementById('obtainedMaterialId').value = '';        
        function savePhoto() {
            const fileInput = document.getElementById('cameraInput');
            const location = document.getElementById('photoLocation').value;
            const notes = document.getElementById('photoNotes').value;
            const pastureId = document.getElementById('photoPasture').value;
            
            if (fileInput.files.length === 0) {
                alert('Please take a photo first');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const photoData = {
                    id: Date.now(),
                    imageData: e.target.result,
                    pastureId: pastureId || null,
                    location: location || 'Unknown location',
                    notes: notes || '',
                    timestamp: new Date().toISOString(),
                    weather: currentWeather ? `${currentWeather.temp}¬∞F, ${currentWeather.condition}` : 'Weather unavailable'
                };
                
                photos.unshift(photoData);
                localStorage.setItem('pasturePhotos', JSON.stringify(photos));
                displayPastures();

                // Clear the file input for next photo
                fileInput.value = '';

                closeModal();
                alert('Photo saved successfully!');

};
reader.onerror = function(error) {
    console.error('Error reading file:', error);
    alert('Error saving photo. Please try again.');
};


reader.readAsDataURL(file);
            
           
        }
        
        function saveNote() {
            const location = document.getElementById('noteLocation').value;
            const content = document.getElementById('noteContent').value;
            const pastureId = document.getElementById('notePasture').value;
            
            if (!content.trim()) {
                alert('Please enter a note');
                return;
            }
            
            const noteData = {
                id: Date.now(),
                pastureId: pastureId || null,
                location: location || 'General',
                content: content,
                timestamp: new Date().toISOString(),
                weather: currentWeather ? `${currentWeather.temp}¬∞F, ${currentWeather.condition}` : 'Weather unavailable'
            };
            
            notes.unshift(noteData);
            localStorage.setItem('pastureNotes', JSON.stringify(notes));
            displayPastures();
            closeModal();
            
            alert('Note saved successfully!');
        }
        
        function deleteEntry(entryId, entryType) {
            if (!confirm('Are you sure you want to delete this entry?')) {
                return;
            }
            
            if (entryType === 'photo') {
                photos = photos.filter(photo => photo.id !== entryId);
                localStorage.setItem('pasturePhotos', JSON.stringify(photos));
            } else {
                notes = notes.filter(note => note.id !== entryId);
                localStorage.setItem('pastureNotes', JSON.stringify(notes));
            }
            
            displayPastures();
        }
        
        // Pasture Management Functions
        function managePastures() {
            document.getElementById('pastureModal').style.display = 'block';
        }
        
        function savePasture() {
            const name = document.getElementById('pastureName').value.trim();
            const acres = parseFloat(document.getElementById('pastureAcres').value) || 0;
            const notes = document.getElementById('pastureNotes').value.trim();
            const editId = document.getElementById('pastureEditId').value;
            
            if (!name) {
                alert('Please enter a pasture name');
                return;
            }
            
            // Check for duplicate names (except when editing the same pasture)
            const existing = pastures.find(p => p.name.toLowerCase() === name.toLowerCase() && p.id !== editId);
            if (existing) {
                alert('A pasture with this name already exists');
                return;
            }
            
            if (editId) {
                // Edit existing pasture
                const pastureIndex = pastures.findIndex(p => p.id == editId);
                if (pastureIndex !== -1) {
                    pastures[pastureIndex] = {
                        ...pastures[pastureIndex],
                        name: name,
                        acres: acres,
                        notes: notes
                    };
                }
            } else {
                // Add new pasture
                const pastureData = {
                    id: Date.now(),
                    name: name,
                    acres: acres,
                    notes: notes,
                    created: new Date().toISOString()
                };
                pastures.push(pastureData);
            }
            
            localStorage.setItem('pastures', JSON.stringify(pastures));
            displayPastures();
            closeModal();
            alert(editId ? 'Pasture updated successfully!' : 'Pasture added successfully!');
        }
        
        function editPasture(pastureId) {
            const pasture = pastures.find(p => p.id == pastureId);
            if (!pasture) return;
            
            document.getElementById('pastureName').value = pasture.name;
            document.getElementById('pastureAcres').value = pasture.acres || '';
            document.getElementById('pastureNotes').value = pasture.notes || '';
            document.getElementById('pastureEditId').value = pasture.id;
            document.getElementById('pastureModalTitle').textContent = 'Edit Pasture';
            document.getElementById('deletePastureBtn').style.display = 'inline-block';
            document.getElementById('pastureModal').style.display = 'block';
        }
        
        function deletePasture() {
            const editId = document.getElementById('pastureEditId').value;
            if (!editId) return;
            
            const pasture = pastures.find(p => p.id == editId);
            if (!pasture) return;
            
            // Check if pasture has photos/notes
            const hasPhotos = photos.some(p => p.pastureId == editId);
            const hasNotes = notes.some(n => n.pastureId == editId);
            
            let confirmMessage = `Are you sure you want to delete "${pasture.name}"?`;
            if (hasPhotos || hasNotes) {
                confirmMessage += '\n\nThis will move all photos and notes in this pasture to "Unassigned".';
            }
            
            if (!confirm(confirmMessage)) return;
            
            // Remove pasture
            pastures = pastures.filter(p => p.id != editId);
            localStorage.setItem('pastures', JSON.stringify(pastures));
            
            // Move photos and notes to unassigned
            photos.forEach(photo => {
                if (photo.pastureId == editId) {
                    photo.pastureId = null;
                }
            });
            notes.forEach(note => {
                if (note.pastureId == editId) {
                    note.pastureId = null;
                }
            });
            
            localStorage.setItem('pasturePhotos', JSON.stringify(photos));
            localStorage.setItem('pastureNotes', JSON.stringify(notes));
            
            displayPastures();
            closeModal();
            alert('Pasture deleted successfully!');
        }
        
        function updatePastureDropdowns() {
            const photoSelect = document.getElementById('photoPasture');
            const noteSelect = document.getElementById('notePasture');
            const assignSelect = document.getElementById('assignPasture');
            
            [photoSelect, noteSelect, assignSelect].forEach(select => {
                // Clear existing options except the first one
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // Add pasture options
                pastures.forEach(pasture => {
                    const option = document.createElement('option');
                    option.value = pasture.id;
                    option.textContent = pasture.name;
                    select.appendChild(option);
                });
            });
        }
        
        function assignPhoto(photoId) {
            updatePastureDropdowns();
            document.getElementById('assignPhotoId').value = photoId;
            document.getElementById('assignModal').style.display = 'block';
        }
        
        function assignPhotoToPasture() {
            const photoId = document.getElementById('assignPhotoId').value;
            const pastureId = document.getElementById('assignPasture').value;
            
            if (!pastureId) {
                alert('Please select a pasture');
                return;
            }
            
            const photo = photos.find(p => p.id == photoId);
            if (photo) {
                photo.pastureId = pastureId;
                localStorage.setItem('pasturePhotos', JSON.stringify(photos));
                displayPastures();
                closeModal();
                alert('Photo assigned successfully!');
            }
        }
        
        function openPhotoView(imageSrc, location, date, time, weather, notes) {
            document.getElementById('photoViewImage').src = imageSrc;
            document.getElementById('photoViewInfo').innerHTML = `
                <strong>${location}</strong><br>
                ${date} ${time}<br>
                ${weather}<br>
                ${notes ? `<em>${notes}</em>` : ''}
            `;
            document.getElementById('photoViewModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closePhotoView() {
            document.getElementById('photoViewModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Animal helper functions
        function getAnimalIcon(type) {
            switch (type) {
                case 'cattle': return 'üêÑ';
                case 'horses': return 'üê¥';
                case 'chickens': return 'üêì';
                case 'dogs': return 'üêï';
                default: return 'üêæ';
            }
        }
        
        // Animal functions
        function addAnimal() {
            document.getElementById('animalModal').style.display = 'block';
        }
        
        function editAnimal(animalId) {
            const animal = animals.find(a => a.id == animalId);
            if (!animal) return;
            
            // Pre-populate basic fields
            document.getElementById('animalName').value = animal.name;
            document.getElementById('animalType').value = animal.type;
            
            // Update dynamic fields based on type
            updateAnimalForm();
            
            // Pre-populate dynamic fields after they're created
            setTimeout(() => {
                if (document.getElementById('animalEarTag')) {
                    document.getElementById('animalEarTag').value = animal.earTag || '';
                }
                if (document.getElementById('animalBreed')) {
                    document.getElementById('animalBreed').value = animal.breed || '';
                }
                if (document.getElementById('animalWeight')) {
                    document.getElementById('animalWeight').value = animal.weight || '';
                }
                if (document.getElementById('animalGender')) {
                    document.getElementById('animalGender').value = animal.gender || '';
                }
                if (document.getElementById('animalColor')) {
                    document.getElementById('animalColor').value = animal.color || '';
                }
                if (document.getElementById('animalCount')) {
                    document.getElementById('animalCount').value = animal.count || '';
                }
                if (document.getElementById('animalPurpose')) {
                    document.getElementById('animalPurpose').value = animal.purpose || '';
                }
                if (document.getElementById('animalBreedingDate')) {
                    document.getElementById('animalBreedingDate').value = animal.breedingDate || '';
                }
                if (document.getElementById('animalDam')) {
                    document.getElementById('animalDam').value = animal.dam || '';
                }
                if (document.getElementById('animalSire')) {
                    document.getElementById('animalSire').value = animal.sire || '';
                }
                if (document.getElementById('animalStatus')) {
                    document.getElementById('animalStatus').value = animal.status || 'healthy';
                }
            }, 50);
            
            // Store the animal ID for saving
            document.getElementById('animalModal').setAttribute('data-edit-id', animalId);
            document.getElementById('animalModal').style.display = 'block';
        }
        
        function deleteAnimal(animalId) {
            console.log('Delete function called with ID:', animalId);
            
            const animal = animals.find(a => a.id == animalId);
            console.log('Found animal:', animal);
            
            if (!animal) {
                alert('Animal not found');
                return;
            }
            
            // Check if animal has treatments
            const animalTreatments = treatments.filter(t => t.animalId == animalId);
            console.log('Found treatments:', animalTreatments.length);
            
            // Set up custom confirmation modal
            let message = `Are you sure you want to delete "${animal.name}"?`;
            if (animalTreatments.length > 0) {
                message += `\n\nThis will also delete ${animalTreatments.length} treatment record(s).`;
            }
            
            document.getElementById('deleteConfirmMessage').innerText = message;
            
            // Set up the confirm button to actually delete
            document.getElementById('confirmDeleteBtn').onclick = function() {
                console.log('User confirmed deletion, proceeding...');
                
                // Remove animal
                animals = animals.filter(a => a.id != animalId);
                localStorage.setItem('animals', JSON.stringify(animals));
                
                // Remove associated treatments
                if (animalTreatments.length > 0) {
                    treatments = treatments.filter(t => t.animalId != animalId);
                    localStorage.setItem('treatments', JSON.stringify(treatments));
                }
                
                displayAnimals();
                closeModal();
                alert('Animal deleted successfully!');
            };
            
            // Show the confirmation modal
            document.getElementById('deleteConfirmModal').style.display = 'block';
        }
        
        function updateAnimalForm() {
            const type = document.getElementById('animalType').value;
            const dynamicFields = document.getElementById('dynamicFields');
            
            if (!type) {
                dynamicFields.innerHTML = '';
                return;
            }
            
            let fieldsHtml = '';
            
            if (type === 'cattle') {
                fieldsHtml = `
                    <div class="form-group">
                        <label for="animalEarTag">Ear Tag #:</label>
                        <input type="text" id="animalEarTag" placeholder="e.g., A123, 456">
                    </div>
                    <div class="form-group">
                        <label for="animalBreed">Breed:</label>
                        <input type="text" id="animalBreed" placeholder="e.g., Angus, Holstein">
                    </div>
                    <div class="form-group">
                        <label for="animalWeight">Weight (lbs):</label>
                        <input type="number" id="animalWeight" placeholder="e.g., 1200">
                    </div>
                    <div class="form-group">
                        <label for="animalGender">Gender:</label>
                        <select id="animalGender">
                            <option value="">Select...</option>
                            <option value="bull">Bull</option>
                            <option value="cow">Cow</option>
                            <option value="steer">Steer</option>
                            <option value="heifer">Heifer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="animalBreedingDate">Last Breeding Date:</label>
                        <input type="date" id="animalBreedingDate" title="283 day gestation period">
                    </div>
                    <div class="form-group">
                        <label for="animalDam">Dam (Mother):</label>
                        <input type="text" id="animalDam" placeholder="e.g., Bessie, A001">
                    </div>
                    <div class="form-group">
                        <label for="animalSire">Sire (Father):</label>
                        <input type="text" id="animalSire" placeholder="e.g., Thunder, B042">
                    </div>
                    <div class="form-group">
                        <label for="animalStatus">Status:</label>
                        <select id="animalStatus">
                            <option value="healthy">üü¢ Healthy</option>
                            <option value="watch">üü° Watch Closely</option>
                            <option value="sick">üî¥ Sick/Injured</option>
                            <option value="pregnant">üîµ Pregnant</option>
                            <option value="sold">‚ö´ Sold</option>
                        </select>
                    </div>
                `;
            } else if (type === 'horses') {
                fieldsHtml = `
                    <div class="form-group">
                        <label for="animalBreed">Breed:</label>
                        <input type="text" id="animalBreed" placeholder="e.g., Quarter Horse, Arabian">
                    </div>
                    <div class="form-group">
                        <label for="animalColor">Color:</label>
                        <input type="text" id="animalColor" placeholder="e.g., Bay, Chestnut">
                    </div>
                    <div class="form-group">
                        <label for="animalGender">Gender:</label>
                        <select id="animalGender">
                            <option value="">Select...</option>
                            <option value="stallion">Stallion</option>
                            <option value="mare">Mare</option>
                            <option value="gelding">Gelding</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="animalBreedingDate">Last Breeding Date:</label>
                        <input type="date" id="animalBreedingDate" title="340 day gestation period">
                    </div>
                    <div class="form-group">
                        <label for="animalDam">Dam (Mother):</label>
                        <input type="text" id="animalDam" placeholder="e.g., Lady, A001">
                    </div>
                    <div class="form-group">
                        <label for="animalSire">Sire (Father):</label>
                        <input type="text" id="animalSire" placeholder="e.g., Thunder, B042">
                    </div>
                    <div class="form-group">
                        <label for="animalStatus">Status:</label>
                        <select id="animalStatus">
                            <option value="healthy">üü¢ Healthy</option>
                            <option value="watch">üü° Watch Closely</option>
                            <option value="sick">üî¥ Sick/Injured</option>
                            <option value="pregnant">üîµ Pregnant</option>
                            <option value="sold">‚ö´ Sold</option>
                        </select>
                    </div>
                `;
            } else if (type === 'chickens') {
                fieldsHtml = `
                    <div class="form-group">
                        <label for="animalCount">Flock Count:</label>
                        <input type="number" id="animalCount" placeholder="e.g., 25">
                    </div>
                    <div class="form-group">
                        <label for="animalBreed">Breed:</label>
                        <input type="text" id="animalBreed" placeholder="e.g., Rhode Island Red">
                    </div>
                    <div class="form-group">
                        <label for="animalPurpose">Purpose:</label>
                        <select id="animalPurpose">
                            <option value="">Select...</option>
                            <option value="layers">Egg Layers</option>
                            <option value="meat">Meat Birds</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="animalStatus">Status:</label>
                        <select id="animalStatus">
                            <option value="healthy">üü¢ Healthy</option>
                            <option value="watch">üü° Watch Closely</option>
                            <option value="sick">üî¥ Sick/Injured</option>
                            <option value="sold">‚ö´ Sold</option>
                        </select>
                    </div>
                `;
            } else if (type === 'dogs') {
                fieldsHtml = `
                    <div class="form-group">
                        <label for="animalBreed">Breed:</label>
                        <input type="text" id="animalBreed" placeholder="e.g., Border Collie, Blue Heeler">
                    </div>
                    <div class="form-group">
                        <label for="animalWeight">Weight (lbs):</label>
                        <input type="number" id="animalWeight" placeholder="e.g., 45">
                    </div>
                    <div class="form-group">
                        <label for="animalGender">Gender:</label>
                        <select id="animalGender">
                            <option value="">Select...</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="animalStatus">Status:</label>
                        <select id="animalStatus">
                            <option value="healthy">üü¢ Healthy</option>
                            <option value="watch">üü° Watch Closely</option>
                            <option value="sick">üî¥ Sick/Injured</option>
                            <option value="sold">‚ö´ Sold</option>
                        </select>
                    </div>
                `;
            }
            
            dynamicFields.innerHTML = fieldsHtml;
        }
        
        function saveAnimal() {
            const name = document.getElementById('animalName').value.trim();
            const type = document.getElementById('animalType').value;
            const editId = document.getElementById('animalModal').getAttribute('data-edit-id');
            
            if (!name) {
                alert('Please enter an animal name');
                return;
            }
            
            if (!type) {
                alert('Please select an animal type');
                return;
            }
            
            // Create base animal object
            const animalData = {
                name: name,
                type: type
            };
            
            // Add type-specific fields
            const breedEl = document.getElementById('animalBreed');
            const weightEl = document.getElementById('animalWeight');
            const genderEl = document.getElementById('animalGender');
            const colorEl = document.getElementById('animalColor');
            const countEl = document.getElementById('animalCount');
            const purposeEl = document.getElementById('animalPurpose');
            const breedingDateEl = document.getElementById('animalBreedingDate');
            const earTagEl = document.getElementById('animalEarTag');
            const damEl = document.getElementById('animalDam');
            const sireEl = document.getElementById('animalSire');
            const statusEl = document.getElementById('animalStatus');

            if (breedEl) animalData.breed = breedEl.value.trim();
            if (weightEl) animalData.weight = weightEl.value;
            if (genderEl) animalData.gender = genderEl.value;
            if (colorEl) animalData.color = colorEl.value.trim();
            if (countEl) animalData.count = countEl.value;
            if (purposeEl) animalData.purpose = purposeEl.value;
            if (breedingDateEl) animalData.breedingDate = breedingDateEl.value;
            if (earTagEl) animalData.earTag = earTagEl.value.trim();
            if (damEl) animalData.dam = damEl.value.trim();
            if (sireEl) animalData.sire = sireEl.value.trim();
            if (statusEl) animalData.status = statusEl.value || 'healthy';            
            if (editId) {
                // Edit existing animal
                const animalIndex = animals.findIndex(a => a.id == editId);
                if (animalIndex !== -1) {
                    animals[animalIndex] = {
                        ...animals[animalIndex],
                        ...animalData
                    };
                }
                alert('Animal updated successfully!');
            } else {
                // Add new animal
                animalData.id = Date.now();
                animals.push(animalData);
                alert('Animal added successfully!');
            }
            
            // Save and refresh
            localStorage.setItem('animals', JSON.stringify(animals));
            displayAnimals();
            closeModal();
        }
        
        function addTreatment() {
            // Update animal dropdown with current animals
            const animalSelect = document.getElementById('treatmentAnimal');
            animalSelect.innerHTML = '<option value="">Select animal...</option>';

            animals.forEach(animal => {
                const icon = getAnimalIcon(animal.type);
                const option = document.createElement('option');
                option.value = animal.id;
                option.textContent = `${icon} ${animal.name}`;
                animalSelect.appendChild(option);
            });

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('treatmentDate').value = today;

            document.getElementById('treatmentModal').style.display = 'block';
        }

        function addTreatmentForAnimal(animalId) {
            // Call addTreatment to populate dropdown
            addTreatment();
            // Pre-select the animal
            document.getElementById('treatmentAnimal').value = animalId;
        }
        
        function saveTreatment() {
            const animalId = document.getElementById('treatmentAnimal').value;
            const treatmentType = document.getElementById('treatmentType').value.trim();
            const treatmentDate = document.getElementById('treatmentDate').value;
            const redoseInterval = document.getElementById('treatmentRedose').value;
            const notes = document.getElementById('treatmentNotes').value.trim();
            
            if (!animalId) {
                alert('Please select an animal');
                return;
            }
            
            if (!treatmentType) {
                alert('Please enter a treatment type');
                return;
            }
            
            if (!treatmentDate) {
                alert('Please enter the date administered');
                return;
            }
            
            // Calculate next due date if redose interval is selected
            let nextDue = null;
            if (redoseInterval) {
                const adminDate = new Date(treatmentDate);
                const nextDueDate = new Date(adminDate);
                
                switch (redoseInterval) {
                    case '1week':
                        nextDueDate.setDate(adminDate.getDate() + 7);
                        break;
                    case '1month':
                        nextDueDate.setMonth(adminDate.getMonth() + 1);
                        break;
                    case '1quarter':
                        nextDueDate.setMonth(adminDate.getMonth() + 3);
                        break;
                    case '6months':
                        nextDueDate.setMonth(adminDate.getMonth() + 6);
                        break;
                    case '1year':
                        nextDueDate.setFullYear(adminDate.getFullYear() + 1);
                        break;
                }
                nextDue = nextDueDate.toISOString();
            }
            
            // Create treatment object
            const treatmentData = {
                id: Date.now(),
                animalId: animalId,
                type: treatmentType,
                dateAdministered: treatmentDate,
                redoseInterval: redoseInterval || null,
                nextDue: nextDue,
                notes: notes || '',
                dateCreated: new Date().toISOString()
            };
            
            // Add to treatments array and save
            treatments.push(treatmentData);
            localStorage.setItem('treatments', JSON.stringify(treatments));
            
            // Refresh display and close modal
            displayAnimals();
            closeModal();
            
            alert('Treatment added successfully!');
        }
        
        function deleteTreatment(treatmentId) {
            console.log('Delete treatment called with ID:', treatmentId);
            
            const treatment = treatments.find(t => t.id == treatmentId);
            const animal = animals.find(a => a.id == treatment.animalId);
            
            if (!treatment || !animal) {
                alert('Treatment or animal not found');
                return;
            }
            
            // Set up custom confirmation modal
            const message = `Are you sure you want to delete this treatment?\n\nAnimal: ${animal.name}\nTreatment: ${treatment.type}\nDate: ${new Date(treatment.dateAdministered).toLocaleDateString()}`;
            
            document.getElementById('deleteConfirmMessage').innerText = message;
            
            // Set up the confirm button to actually delete
            document.getElementById('confirmDeleteBtn').onclick = function() {
                console.log('User confirmed treatment deletion, proceeding...');
                
                // Remove treatment
                treatments = treatments.filter(t => t.id != treatmentId);
                localStorage.setItem('treatments', JSON.stringify(treatments));
                
                displayAnimals();
                closeModal();
                alert('Treatment deleted successfully!');
            };
            
            // Show the confirmation modal
            document.getElementById('deleteConfirmModal').style.display = 'block';
        }
        
        // Animal filter function
        function filterAnimals(type) {
            currentAnimalFilter = type;
            
            // Update filter button active state
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayAnimals();
        }
        
        // Animals display function
        function updateTreatmentAlerts() {
            const alertsSection = document.getElementById('treatmentAlertsSection');
            const alertsList = document.getElementById('treatmentAlertsList');
            const today = new Date();
            const alerts = [];

            // Check all treatments
            treatments.forEach(treatment => {
                if (!treatment.nextDue) return;
                const animal = animals.find(a => a.id == treatment.animalId);
                if (!animal) return;

                const nextDue = new Date(treatment.nextDue);
                const daysUntilDue = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24));

                if (daysUntilDue <= 14) {
                    const icon = getAnimalIcon(animal.type);
                    let urgency = 'normal';
                    let color = '#333';

                    if (daysUntilDue < 0) {
                        urgency = 'overdue';
                        color = '#dc3545';
                    } else if (daysUntilDue <= 3) {
                        urgency = 'urgent';
                        color = '#ff6b6b';
                    } else if (daysUntilDue <= 7) {
                        urgency = 'soon';
                        color = '#f39c12';
                    }

                    alerts.push({
                        urgency,
                        daysUntilDue,
                        html: `<div style="margin: 0.5rem 0; padding: 0.5rem; background: white; border-radius: 4px; border-left: 3px solid ${color};">
                            <strong style="color: ${color};">${icon} ${animal.name}</strong> - ${treatment.type}
                            <br><span style="font-size: 0.85rem; color: #666;">${daysUntilDue < 0 ? `Overdue ${Math.abs(daysUntilDue)} days` : daysUntilDue === 0 ? 'Due today!' : `Due in ${daysUntilDue} days`}</span>
                        </div>`
                    });
                }
            });

            // Check breeding due dates
            animals.forEach(animal => {
                if (!animal.breedingDate) return;

                const breedDate = new Date(animal.breedingDate);
                const dueDate = new Date(breedDate);
                const gestationDays = animal.type === 'cattle' ? 283 : animal.type === 'horses' ? 340 : 0;
                if (!gestationDays) return;

                dueDate.setDate(breedDate.getDate() + gestationDays);
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                if (daysUntilDue <= 14) {
                    const icon = getAnimalIcon(animal.type);
                    const eventName = animal.type === 'cattle' ? 'Calving' : 'Foaling';
                    let color = '#228B22';

                    if (daysUntilDue < 0) {
                        color = '#dc3545';
                    } else if (daysUntilDue <= 7) {
                        color = '#f39c12';
                    }

                    alerts.push({
                        urgency: daysUntilDue < 0 ? 'overdue' : daysUntilDue <= 7 ? 'urgent' : 'soon',
                        daysUntilDue,
                        html: `<div style="margin: 0.5rem 0; padding: 0.5rem; background: white; border-radius: 4px; border-left: 3px solid ${color};">
                            <strong style="color: ${color};">${icon} ${animal.name}</strong> - ${eventName}
                            <br><span style="font-size: 0.85rem; color: #666;">${daysUntilDue < 0 ? `Overdue ${Math.abs(daysUntilDue)} days` : daysUntilDue === 0 ? 'Due today!' : `Due in ${daysUntilDue} days`}</span>
                        </div>`
                    });
                }
            });

            // Sort by urgency and days
            const urgencyOrder = { overdue: 0, urgent: 1, soon: 2, normal: 3 };
            alerts.sort((a, b) => {
                if (urgencyOrder[a.urgency] !== urgencyOrder[b.urgency]) {
                    return urgencyOrder[a.urgency] - urgencyOrder[b.urgency];
                }
                return a.daysUntilDue - b.daysUntilDue;
            });

            if (alerts.length > 0) {
                alertsList.innerHTML = alerts.map(a => a.html).join('');
                alertsSection.classList.remove('hidden');
            } else {
                alertsSection.classList.add('hidden');
            }
        }

        function displayAnimals() {
            updateTreatmentAlerts();
            const container = document.getElementById('animalsList');
            
            // Filter animals based on current filter
            let filteredAnimals = animals;
            if (currentAnimalFilter !== 'all') {
                filteredAnimals = animals.filter(animal => animal.type === currentAnimalFilter);
            }
            
            if (filteredAnimals.length === 0) {
                const message = currentAnimalFilter === 'all' ? 
                    '<h3>üêæ No animals yet!</h3>' : 
                    `<h3>üêæ No ${currentAnimalFilter} yet!</h3>`;
                container.innerHTML = `<div class="empty-animals">${message}</div>`;
                return;
            }
            
            // Display filtered animal list
            let html = '';
            filteredAnimals.forEach(animal => {
                const icon = getAnimalIcon(animal.type);
                
                // Get next treatment due for this animal
                const animalTreatments = treatments.filter(t => t.animalId == animal.id && t.nextDue);
                const allTreatments = treatments.filter(t => t.animalId == animal.id);
                let nextTreatmentDue = 'None scheduled';
                let nextTreatmentType = 'None';
                let dueSoon = false;
                
                if (animalTreatments.length > 0) {
                    // Find the earliest due date
                    const sortedTreatments = animalTreatments.sort((a, b) => new Date(a.nextDue) - new Date(b.nextDue));
                    const nextTreatment = sortedTreatments[0];
                    const nextDue = new Date(nextTreatment.nextDue);
                    const today = new Date();
                    const daysUntilDue = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24));
                    
                    nextTreatmentType = nextTreatment.type;
                    
                    if (daysUntilDue < 0) {
                        nextTreatmentDue = `Overdue ${Math.abs(daysUntilDue)} days`;
                        dueSoon = true;
                    } else if (daysUntilDue <= 7) {
                        nextTreatmentDue = daysUntilDue === 0 ? 'Due today!' : `Due in ${daysUntilDue} days`;
                        dueSoon = true;
                    } else {
                        nextTreatmentDue = nextDue.toLocaleDateString();
                    }
                }
                
                // Build details string based on animal type
                // Build details string based on animal type
let details = '';
let breedingInfo = '';

// Get status emoji
const statusEmoji = {
    'healthy': 'üü¢',
    'watch': 'üü°',
    'sick': 'üî¥',
    'pregnant': 'üîµ',
    'sold': '‚ö´'
}[animal.status || 'healthy'];

// Build pedigree info
const pedigreeInfo = [];
if (animal.dam) pedigreeInfo.push(`Dam: ${animal.dam}`);
if (animal.sire) pedigreeInfo.push(`Sire: ${animal.sire}`);
const pedigreeStr = pedigreeInfo.length > 0 ? pedigreeInfo.join(' ‚Ä¢ ') : '';

if (animal.type === 'cattle') {
    const detailsParts = [animal.breed, animal.gender, animal.weight ? `${animal.weight} lbs` : ''];
    if (animal.earTag) detailsParts.unshift(`Tag: ${animal.earTag}`);
    details = detailsParts.filter(Boolean).join(' ‚Ä¢ ');
    if (animal.breedingDate) {
        const breedDate = new Date(animal.breedingDate);
        const dueDate = new Date(breedDate);
        dueDate.setDate(breedDate.getDate() + 283); // 283 day gestation
        const today = new Date();
        const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

        if (daysUntilDue < 0) {
            breedingInfo = `Calving overdue ${Math.abs(daysUntilDue)} days`;
        } else if (daysUntilDue <= 14) {
            breedingInfo = daysUntilDue === 0 ? 'Calving due today!' : `Calving due in ${daysUntilDue} days`;
        } else {
            breedingInfo = `Calving due: ${dueDate.toLocaleDateString()}`;
        }
    }
} else if (animal.type === 'horses') {
    details = [animal.breed, animal.color, animal.gender].filter(Boolean).join(' ‚Ä¢ ');
    if (animal.breedingDate) {
        const breedDate = new Date(animal.breedingDate);
        const dueDate = new Date(breedDate);
        dueDate.setDate(breedDate.getDate() + 340); // 340 day gestation
        const today = new Date();
        const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysUntilDue < 0) {
            breedingInfo = `Foaling overdue ${Math.abs(daysUntilDue)} days`;
        } else if (daysUntilDue <= 14) {
            breedingInfo = daysUntilDue === 0 ? 'Foaling due today!' : `Foaling due in ${daysUntilDue} days`;
        } else {
            breedingInfo = `Foaling due: ${dueDate.toLocaleDateString()}`;
        }
    }
} else if (animal.type === 'horses') {
                    details = [animal.breed, animal.color, animal.gender].filter(Boolean).join(' ‚Ä¢ ');
                } else if (animal.type === 'chickens') {
                    details = [animal.count ? `${animal.count} birds` : '', animal.breed, animal.purpose].filter(Boolean).join(' ‚Ä¢ ');
                } else if (animal.type === 'dogs') {
                    details = [animal.breed, animal.gender, animal.weight ? `${animal.weight} lbs` : ''].filter(Boolean).join(' ‚Ä¢ ');
                }
                
                html += `
                    <div class="animal-card">
                        <div class="animal-header">
                            <div>
                                <h3 class="animal-name">${icon} ${animal.name} ${statusEmoji}</h3>
                                <div class="animal-type">${animal.type}</div>
                                ${details ? `<div style="font-size: 0.8rem; color: #888; margin-top: 0.25rem;">${details}</div>` : ''}
${pedigreeStr ? `<div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem; font-style: italic;">${pedigreeStr}</div>` : ''}
${breedingInfo ? `<div style="font-size: 0.8rem; color: #228B22; margin-top: 0.25rem; font-weight: bold;">${breedingInfo}</div>` : ''}
                            </div>
                            <div class="pasture-actions" style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <button class="btn-small" onclick="addTreatmentForAnimal(${animal.id})" style="background: #17a2b8; color: white;" title="Add Treatment">üíâ</button>
                                <button class="btn-small btn-edit" onclick="editAnimal(${animal.id})" title="Edit">‚úèÔ∏è</button>
                                <button class="btn-small btn-delete" onclick="deleteAnimal(${animal.id})" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        
                        <div class="pasture-info">
                            <div class="info-item" style="grid-column: 1 / -1;">
                                <div class="info-label">Upcoming Treatments</div>
                                <div class="info-value" style="font-size: 0.8rem; color: ${dueSoon ? '#dc3545' : '#333'}; font-weight: ${dueSoon ? 'bold' : 'normal'}; line-height: 1.3;">${nextTreatmentType}</div>
                            </div>
                        </div>
                        
                        ${allTreatments.length > 0 ? `
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                                <h4 style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Recent Treatments:</h4>
                                <div style="font-size: 0.8rem; color: #888;">
                                    ${allTreatments.slice(0, 3).map(t => `
                                        <div style="margin-bottom: 0.25rem; display: flex; justify-content: space-between; align-items: flex-start;">
                                            <div style="flex: 1;">
                                                <strong>${t.type}</strong> - ${t.lastCompleted ? `Last given: ${new Date(t.lastCompleted).toLocaleDateString()}` : `Scheduled: ${new Date(t.dateAdministered).toLocaleDateString()}`}
                                                ${t.notes ? `<br><em>${t.notes}</em>` : ''}
                                            </div>
                                            <button onclick="markTreatmentComplete(${t.id})" style="background: #28a745; color: white; border: none; border-radius: 3px; padding: 2px 4px; font-size: 10px; cursor: pointer; margin-left: 0.5rem;" title="Mark as completed today">‚úì</button>     
                                            <button onclick="deleteTreatment(${t.id})" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; cursor: pointer; margin-left: 0.5rem; flex-shrink: 0;" title="Delete treatment">√ó</button>
                                        </div>
                                    `).join('')}
                                    ${allTreatments.length > 3 ? `<div style="color: #666; font-style: italic;">... and ${allTreatments.length - 3} more</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function displayPastures() {
            const container = document.getElementById('pasturesList');
            const unassignedSection = document.getElementById('unassignedPhotos');
            const unassignedGrid = document.getElementById('unassignedGrid');
            
            // Get unassigned photos and notes
            const unassignedPhotos = photos.filter(p => !p.pastureId);
            const unassignedNotes = notes.filter(n => !n.pastureId);
            const unassignedEntries = [
                ...unassignedPhotos.map(p => ({...p, type: 'photo'})),
                ...unassignedNotes.map(n => ({...n, type: 'note'}))
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Display unassigned section
            if (unassignedEntries.length > 0) {
                unassignedSection.classList.remove('hidden');
                unassignedGrid.innerHTML = unassignedEntries.map(entry => {
                    const date = new Date(entry.timestamp).toLocaleDateString();
                    const time = new Date(entry.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    if (entry.type === 'photo') {
                        return `
                            <div class="photo-item">
                                <button class="delete-btn" onclick="deleteEntry(${entry.id}, 'photo')" title="Delete photo">√ó</button>
                                <button class="assign-photo-btn" onclick="assignPhoto(${entry.id})" title="Assign to pasture">üìç</button>
                                <img src="${entry.imageData}" alt="Pasture photo" 
                                     onclick="openPhotoView('${entry.imageData}', '${entry.location}', '${date}', '${time}', '${entry.weather}', '${entry.notes || ''}')">
                                <div class="photo-info">
                                    <strong>${entry.location}</strong><br>
                                    ${date} ${time}<br>
                                    ${entry.weather}<br>
                                    ${entry.notes ? `<em>${entry.notes}</em>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="photo-item">
                                <button class="delete-btn" onclick="deleteEntry(${entry.id}, 'note')" title="Delete note">√ó</button>
                                <div style="height: 150px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #666;">
                                    üìù<br>NOTE
                                </div>
                                <div class="photo-info">
                                    <strong>${entry.location}</strong><br>
                                    ${date} ${time}<br>
                                    ${entry.weather}<br>
                                    <em>${entry.content}</em>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            } else {
                unassignedSection.classList.add('hidden');
            }
            
            // Display pastures
            if (pastures.length === 0) {
                container.innerHTML = `
                    <div class="empty-pasture">
                        <h3>üåæ No Pastures Yet</h3>
                        <p>Click "Manage Pastures" above to add your first pasture!</p>
                        <p style="margin-top: 1rem;"><em>Organizing your ranch by individual pastures makes tracking much easier.</em></p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pastures.map(pasture => {
                const pasturePhotos = photos.filter(p => p.pastureId == pasture.id);
                const pastureNotes = notes.filter(n => n.pastureId == pasture.id);
                const allEntries = [
                    ...pasturePhotos.map(p => ({...p, type: 'photo'})),
                    ...pastureNotes.map(n => ({...n, type: 'note'}))
                ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                const lastUpdate = allEntries.length > 0 ? 
                    new Date(allEntries[0].timestamp).toLocaleDateString() : 
                    'No entries yet';
                
                return `
                    <div class="pasture-card">
                        <div class="pasture-header">
                            <div>
                                <h3 class="pasture-name">${pasture.name}</h3>
                                <div class="pasture-stats">
                                    ${pasture.acres ? `${pasture.acres} acres ‚Ä¢ ` : ''}
                                    ${allEntries.length} entries ‚Ä¢ Last: ${lastUpdate}
                                </div>
                            </div>
                            <div class="pasture-actions">
                                <button class="btn-small btn-edit" onclick="editPasture(${pasture.id})">Edit</button>
                            </div>
                        </div>
                        
                        ${pasture.notes ? `<p style="color: #666; font-style: italic; margin-bottom: 1rem;">${pasture.notes}</p>` : ''}
                        
                        <div class="pasture-info">
                            <div class="info-item">
                                <div class="info-label">Photos</div>
                                <div class="info-value">${pasturePhotos.length}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Notes</div>
                                <div class="info-value">${pastureNotes.length}</div>
                            </div>
                        </div>
                        
                        ${allEntries.length > 0 ? `
                            <div class="photo-grid">
                                ${allEntries.slice(0, 6).map(entry => {
                                    const date = new Date(entry.timestamp).toLocaleDateString();
                                    const time = new Date(entry.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                    
                                    if (entry.type === 'photo') {
                                        return `
                                            <div class="photo-item">
                                                <button class="delete-btn" onclick="deleteEntry(${entry.id}, 'photo')" title="Delete photo">√ó</button>
                                                <img src="${entry.imageData}" alt="Pasture photo" 
                                                     onclick="openPhotoView('${entry.imageData}', '${pasture.name} - ${entry.location}', '${date}', '${time}', '${entry.weather}', '${entry.notes || ''}')">
                                                <div class="photo-info">
                                                    <strong>${entry.location}</strong><br>
                                                    ${date} ${time}<br>
                                                    ${entry.weather}<br>
                                                    ${entry.notes ? `<em>${entry.notes}</em>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    } else {
                                        return `
                                            <div class="photo-item">
                                                <button class="delete-btn" onclick="deleteEntry(${entry.id}, 'note')" title="Delete note">√ó</button>
                                                <div style="height: 150px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #666;">
                                                    üìù<br>NOTE
                                                </div>
                                                <div class="photo-info">
                                                    <strong>${entry.location}</strong><br>
                                                    ${date} ${time}<br>
                                                    ${entry.weather}<br>
                                                    <em>${entry.content}</em>
                                                </div>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                            </div>
                            ${allEntries.length > 6 ? `<p style="text-align: center; color: #666; margin-top: 0.5rem; font-size: 0.9rem;">... and ${allEntries.length - 6} more entries</p>` : ''}
                        ` : `
                            <div class="empty-pasture">
                                <p>üì∑ No photos or notes yet for this pasture</p>
                                <p style="font-size: 0.9rem; color: #888;">Take a photo or add a note to start tracking!</p>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }
        
        // Notification functions
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notifications enabled');
                        scheduleNotifications();
                    }
                });
            }
        }
        
        function testNotification() {
            if (!('Notification' in window)) {
                alert('This browser does not support notifications');
                return;
            }
            
            if (Notification.permission === 'granted') {
                new Notification('üîî Test Notification', {
                    body: 'Notifications are working on your device!',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="#228B22" width="100" height="100"/><text y="70" font-size="60" text-anchor="middle" x="50" fill="white">üêÑ</text></svg>'
                });
            } else if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        alert('Permission granted! Try the test button again.');
                    } else {
                        alert('Notification permission denied. Enable in browser settings.');
                    }
                });
            } else {
                alert('Notifications blocked. Enable in browser/device settings.');
            }
        }
        
        function checkTreatmentNotifications() {
            if (Notification.permission !== 'granted') return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Check all treatments with due dates
            const dueTreatments = treatments.filter(t => t.nextDue);
            
            dueTreatments.forEach(treatment => {
                const dueDate = new Date(treatment.nextDue);
                dueDate.setHours(0, 0, 0, 0);
                
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                const animal = animals.find(a => a.id == treatment.animalId);
                
                if (!animal) return;
                
                const animalIcon = getAnimalIcon(animal.type);
                let notificationTitle = '';
                let notificationBody = '';
                
                if (daysUntilDue < 0) {
                    // Overdue
                    notificationTitle = `${animalIcon} Treatment Overdue!`;
                    notificationBody = `${animal.name} - ${treatment.type} was due ${Math.abs(daysUntilDue)} days ago`;
                } else if (daysUntilDue === 0) {
                    // Due today
                    notificationTitle = `${animalIcon} Treatment Due Today!`;
                    notificationBody = `${animal.name} - ${treatment.type} is due today`;
                } else if (daysUntilDue <= 3) {
                    // Due soon (within 3 days)
                    notificationTitle = `${animalIcon} Treatment Due Soon`;
                    notificationBody = `${animal.name} - ${treatment.type} due in ${daysUntilDue} days`;
                }
                
                // Send notification if we have a message
                if (notificationTitle) {
                    new Notification(notificationTitle, {
                        body: notificationBody,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="#ff6b35" width="100" height="100"/><text y="70" font-size="60" text-anchor="middle" x="50" fill="white">üíâ</text></svg>'
                    });
                }
            });
        }
        function checkBreedingNotifications() {
    if (Notification.permission !== 'granted') return;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Check cattle and horses with breeding dates
    const breedingAnimals = animals.filter(a => 
        (a.type === 'cattle' || a.type === 'horses') && a.breedingDate
    );
    
    breedingAnimals.forEach(animal => {
        const breedDate = new Date(animal.breedingDate);
        const dueDate = new Date(breedDate);
        
        // Add gestation period
        if (animal.type === 'cattle') {
            dueDate.setDate(breedDate.getDate() + 283);
        } else if (animal.type === 'horses') {
            dueDate.setDate(breedDate.getDate() + 340);
        }
        
        dueDate.setHours(0, 0, 0, 0);
        const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        
        const animalIcon = getAnimalIcon(animal.type);
        const eventType = animal.type === 'cattle' ? 'Calving' : 'Foaling';
        let notificationTitle = '';
        let notificationBody = '';
        
        if (daysUntilDue < 0) {
            // Overdue
            notificationTitle = `${animalIcon} ${eventType} Overdue!`;
            notificationBody = `${animal.name} - ${eventType.toLowerCase()} was due ${Math.abs(daysUntilDue)} days ago`;
        } else if (daysUntilDue === 0) {
            // Due today
            notificationTitle = `${animalIcon} ${eventType} Due Today!`;
            notificationBody = `${animal.name} - ${eventType.toLowerCase()} is due today`;
        } else if (daysUntilDue <= 7) {
            // Due soon (within 7 days)
            notificationTitle = `${animalIcon} ${eventType} Due Soon`;
            notificationBody = `${animal.name} - ${eventType.toLowerCase()} due in ${daysUntilDue} days`;
        }
        
        // Send notification if we have a message
        if (notificationTitle) {
            new Notification(notificationTitle, {
                body: notificationBody,
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="#228B22" width="100" height="100"/><text y="70" font-size="60" text-anchor="middle" x="50" fill="white">üêÑ</text></svg>'
            });
        }
    });
}        
        function scheduleNotifications() {
            const now = new Date();
            const tomorrow7AM = new Date(now);
            tomorrow7AM.setDate(tomorrow7AM.getDate() + 1);
            tomorrow7AM.setHours(7, 0, 0, 0);
            
            const msUntil7AM = tomorrow7AM.getTime() - now.getTime();
            
            setTimeout(() => {
                checkShreddingConditions();
                checkTreatmentNotifications();
                checkBreedingNotifications();                        setInterval(() => {
                    checkShreddingConditions();
                    checkTreatmentNotifications();
                    checkBreedingNotifications();                    }, 24 * 60 * 60 * 1000);
            }, msUntil7AM);
        }
        
        function checkShreddingConditions() {
            if (currentWeather && currentWeather.windSpeed < 10 && currentWeather.temp < 95) {
                if (Notification.permission === 'granted') {
                    new Notification('üåæ Perfect Shredding Weather!', {
                        body: `${currentWeather.temp}¬∞F, ${currentWeather.windSpeed}mph wind. Great conditions for weed control.`,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="#228B22" width="100" height="100"/><text y="70" font-size="60" text-anchor="middle" x="50" fill="white">üåæ</text></svg>'
                    });
                }
            }
        }
        
        // Refresh weather every 30 minutes
        setInterval(loadWeather, 30 * 60 * 1000);

        // Offline functionality
function initializeOfflineMode() {
    updateConnectionStatus();
    
    window.addEventListener('online', function() {
        updateConnectionStatus();
        showConnectionMessage('üü¢ Back online!', 'success');
    });
    
    window.addEventListener('offline', function() {
        updateConnectionStatus();
        showConnectionMessage('üî¥ Working offline', 'warning');
    });
}

function updateConnectionStatus() {
    const isOnline = navigator.onLine;
    const statusElement = document.querySelector('.location');
    if (statusElement) {
        const currentText = statusElement.textContent;
        if (isOnline) {
            statusElement.textContent = currentText.replace(' (OFFLINE)', '');
        } else {
            if (!currentText.includes('(OFFLINE)')) {
                statusElement.textContent = currentText + ' (OFFLINE)';
            }
        }
    }
}

function showConnectionMessage(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.style.cssText = `
        position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
        background: ${type === 'success' ? '#d4edda' : '#fff3cd'};
        color: ${type === 'success' ? '#155724' : '#856404'};
        padding: 0.75rem 1rem; border-radius: 5px; z-index: 1001;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    `;
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}


// Data backup and restore functions
function backupData() {
    const backupData = {
        version: '2.08',
        timestamp: new Date().toISOString(),
        data: {
            pasturePhotos: JSON.parse(localStorage.getItem('pasturePhotos') || '[]'),
            pastureNotes: JSON.parse(localStorage.getItem('pastureNotes') || '[]'),
            pastures: JSON.parse(localStorage.getItem('pastures') || '[]'),
            animals: JSON.parse(localStorage.getItem('animals') || '[]'),
            treatments: JSON.parse(localStorage.getItem('treatments') || '[]'),
            projects: JSON.parse(localStorage.getItem('projects') || '[]'),
            materials: JSON.parse(localStorage.getItem('materials') || '[]'),
            burnBanStatus: JSON.parse(localStorage.getItem('burnBanStatus') || '{"fayette": {"active": false, "expires": ""}}')
        }
    };
    
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `pasture-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    const totalItems = Object.values(backupData.data).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 1), 0);
    alert(`Backup created! ${totalItems} items backed up.`);
}

function restoreData() {
    const fileInput = document.getElementById('restoreInput');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backupData = JSON.parse(e.target.result);
            
            if (!backupData.data) {
                alert('Invalid backup file format');
                return;
            }
            
            const confirmRestore = confirm(`Restore from backup dated ${new Date(backupData.timestamp).toLocaleDateString()}?\n\nThis will replace ALL current data!`);
            
            if (confirmRestore) {
                // Restore all data
                Object.keys(backupData.data).forEach(key => {
                    localStorage.setItem(key, JSON.stringify(backupData.data[key]));
                });
                
                // Reload the page to refresh all displays
                location.reload();
            }
        } catch (error) {
            alert('Error reading backup file: ' + error.message);
        }
    };
    
    reader.readAsText(file);
    fileInput.value = ''; // Clear the input
}

function markTreatmentComplete(treatmentId) {
    const treatment = treatments.find(t => t.id == treatmentId);
    if (!treatment) return;
    
    const today = new Date();
const localDate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000));
const todayString = localDate.toISOString().split('T')[0];
    
    // Record completion
    treatment.lastCompleted = today;
    
    // Calculate next due date from today
    if (treatment.redoseInterval) {
       const nextDueDate = new Date(today);
        switch (treatment.redoseInterval) {
            case '1week':
                nextDueDate.setDate(nextDueDate.getDate() + 7);
                break;
            case '1month':
                nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                break;
            case '1quarter':
                nextDueDate.setMonth(nextDueDate.getMonth() + 3);
                break;
            case '6months':
                nextDueDate.setMonth(nextDueDate.getMonth() + 6);
                break;
            case '1year':
                nextDueDate.setFullYear(nextDueDate.getFullYear() + 1);
                break;
        }
        treatment.nextDue = nextDueDate.toISOString();
    } else {
        treatment.nextDue = null;
    }
    
    localStorage.setItem('treatments', JSON.stringify(treatments));
    displayAnimals();
    alert(`Treatment completed! Next due: ${treatment.nextDue ? new Date(treatment.nextDue).toLocaleDateString() : 'None scheduled'}`);
    
}        
        
        // Close modal on outside click
        window.onclick = function(event) {
            const photoModal = document.getElementById('photoModal');
            const noteModal = document.getElementById('noteModal');
            const pastureModal = document.getElementById('pastureModal');
            const assignModal = document.getElementById('assignModal');
            const animalModal = document.getElementById('animalModal');
            const treatmentModal = document.getElementById('treatmentModal');
            const deleteConfirmModal = document.getElementById('deleteConfirmModal');
            const photoViewModal = document.getElementById('photoViewModal');
            
            if (event.target === photoModal || event.target === noteModal || 
                event.target === pastureModal || event.target === assignModal ||
                event.target === animalModal || event.target === treatmentModal ||
                event.target === deleteConfirmModal) {
                closeModal();
            } else if (event.target === photoViewModal) {
                closePhotoView();
            }
        }
       // Project Management Functions
let projects = JSON.parse(localStorage.getItem('projects') || '[]');

function addProject() {
    document.getElementById('projectModal').style.display = 'block';
}

function saveProject() {
    const name = document.getElementById('projectName').value.trim();
    const priority = document.getElementById('projectPriority').value;
    const dueDate = document.getElementById('projectDueDate').value;
    const description = document.getElementById('projectDescription').value.trim();
    
    if (!name) {
        alert('Please enter a project name');
        return;
    }
    
    const editId = document.getElementById('projectModal').getAttribute('data-edit-id');

    if (editId) {
        // Edit existing project
        const projectIndex = projects.findIndex(p => p.id == editId);
        if (projectIndex !== -1) {
            projects[projectIndex] = {
                ...projects[projectIndex],
                name: name,
                priority: priority,
                dueDate: dueDate,
                description: description
            };
        }
        document.getElementById('projectModal').removeAttribute('data-edit-id');
        alert('Project updated successfully!');
    } else {
        // Add new project
        const projectData = {
            id: Date.now(),
            name: name,
            priority: priority,
            dueDate: dueDate,
            description: description,
            tasks: [],
            completed: false,
            created: new Date().toISOString()
        };
        projects.push(projectData);
        alert('Project added successfully!');
    }

    localStorage.setItem('projects', JSON.stringify(projects));
    displayProjects();
    closeModal();
}

function editProject(projectId) {
    const project = projects.find(p => p.id == projectId);
    if (!project) return;
    
    document.getElementById('projectName').value = project.name;
    document.getElementById('projectPriority').value = project.priority;
    document.getElementById('projectDueDate').value = project.dueDate || '';
    document.getElementById('projectDescription').value = project.description || '';
    
    document.getElementById('projectModal').setAttribute('data-edit-id', projectId);
    document.getElementById('projectModal').style.display = 'block';
}

function deleteProject(projectId) {
    const project = projects.find(p => p.id == projectId);
    if (!project) return;
    
    if (confirm(`Are you sure you want to delete "${project.name}"?`)) {
        projects = projects.filter(p => p.id != projectId);
        localStorage.setItem('projects', JSON.stringify(projects));
        displayProjects();
        alert('Project deleted successfully!');
    }
}

function displayProjects() {
    const container = document.getElementById('projectsList');
    
    if (projects.length === 0) {
        container.innerHTML = `
            <div class="empty-pasture">
                <h3>üîß No Projects Yet</h3>
                <p>Click "Add Project" above to start tracking your farm projects!</p>
                <p style="margin-top: 1rem;"><em>Perfect for fence repairs, barn maintenance, equipment fixes, etc.</em></p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = projects.map(project => {
        const priorityIcon = project.priority === 'urgent' ? 'üö®' : 
                            project.priority === 'high' ? 'üî¥' : 
                            project.priority === 'medium' ? 'üü°' : 'üü¢';
        const dueDate = project.dueDate ? new Date(project.dueDate).toLocaleDateString() : 'No due date';
        
        return `
            <div class="pasture-card" style="border-left-color: ${project.priority === 'urgent' || project.priority === 'high' ? '#dc3545' : '#228B22'};">
                <div class="pasture-header">
                    <div>
                        <h3 class="pasture-name">${priorityIcon} ${project.name}</h3>
                        <div class="pasture-stats">Due: ${dueDate} ‚Ä¢ Created: ${new Date(project.created).toLocaleDateString()}</div>
                    </div>
                    <div class="pasture-actions">
                        <button class="btn-small btn-edit" onclick="editProject(${project.id})">Edit</button>
                        <button class="btn-small btn-delete" onclick="deleteProject(${project.id})">Delete</button>
                    </div>
                </div>
                ${project.description ? `<p style="color: #666; margin: 1rem 0;">${project.description}</p>` : ''}
                
                ${(() => {
                    const projectMaterials = materials.filter(m => m.projectId == project.id);
                    if (projectMaterials.length === 0) {
                        return `<p style="color: #888; font-style: italic; margin: 1rem 0;">No materials added yet</p>`;
                    }
                    
                    const totalCost = projectMaterials.reduce((sum, m) => sum + (m.actualCost || m.estimatedCost), 0);
                    const obtainedCount = projectMaterials.filter(m => m.obtained).length;
                    
                    return `
                        <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <h4 style="margin: 0; color: #666;">üì¶ Materials (${obtainedCount}/${projectMaterials.length})</h4>
                                <span style="font-weight: bold; color: #228B22;">$${totalCost.toFixed(2)}</span>
                            </div>
                            ${projectMaterials.map(material => {
                                const categoryIcon = {
                                    lumber: 'ü™µ', hardware: 'üî©', tools: 'üî®', 
                                    concrete: 'üß±', paint: 'üé®', electrical: '‚ö°', other: 'üì¶'
                                }[material.category] || 'üì¶';
                                
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; margin-bottom: 0.5rem; background: white; border-radius: 6px; border-left: 3px solid ${material.obtained ? '#28a745' : '#007bff'};">
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; ${material.obtained ? 'text-decoration: line-through; color: #28a745;' : ''}">${categoryIcon} ${material.name}</div>
                                            <div style="font-size: 0.8rem; color: #666;">
                                                ${material.quantityObtained}/${material.quantityNeeded} ${material.unit} ‚Ä¢ $${(material.actualCost || material.estimatedCost).toFixed(2)}
                                            </div>
                                            ${material.notes ? `<div style="font-size: 0.7rem; color: #888; font-style: italic;">${material.notes}</div>` : ''}
                                        </div>
                                        <div style="display: flex; gap: 0.25rem;">
                                            ${!material.obtained ? 
                                                `<button onclick="markAsObtained(${material.id})" style="background: #28a745; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.4rem; font-size: 0.7rem; cursor: pointer;">‚úì Got it</button>` : 
                                                `<span style="color: #28a745; font-size: 0.8rem;">‚úÖ</span>`
                                            }
                                            <button onclick="editMaterial(${material.id})" style="background: #ffc107; color: black; border: none; border-radius: 3px; padding: 0.2rem 0.4rem; font-size: 0.7rem; cursor: pointer;">Edit</button>
                                            <button onclick="deleteMaterial(${material.id})" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.4rem; font-size: 0.7rem; cursor: pointer;">√ó</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                })()}
            </div>
        `;
    }).join('');
}

// Materials Management
let materials = JSON.parse(localStorage.getItem('materials') || '[]');

function viewMaterials() {
    // Update project dropdown
    updateMaterialProjectDropdown();
    
    // For now, just open the add material modal
    document.getElementById('materialsModal').style.display = 'block';
}

function updateMaterialProjectDropdown() {
    const select = document.getElementById('materialProject');
    select.innerHTML = '<option value="">Select project...</option>';
    
    projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        select.appendChild(option);
    });
}

function saveMaterial() {
    const projectId = document.getElementById('materialProject').value;
    const name = document.getElementById('materialName').value.trim();
    const category = document.getElementById('materialCategory').value;
    const quantityNeeded = parseFloat(document.getElementById('materialQuantityNeeded').value) || 0;
    const unit = document.getElementById('materialUnit').value.trim();
    const estimatedCost = parseFloat(document.getElementById('materialEstimatedCost').value) || 0;
    const notes = document.getElementById('materialNotes').value.trim();
    const editId = document.getElementById('materialEditId').value;
    
    if (!projectId) {
        alert('Please select a project');
        return;
    }
    
    if (!name) {
        alert('Please enter a material name');
        return;
    }
    
    if (editId) {
        // Edit existing material
        const materialIndex = materials.findIndex(m => m.id == editId);
        if (materialIndex !== -1) {
            materials[materialIndex] = {
                ...materials[materialIndex],
                projectId: projectId,
                name: name,
                category: category,
                quantityNeeded: quantityNeeded,
                unit: unit,
                estimatedCost: estimatedCost,
                notes: notes
            };
        }
        alert('Material updated successfully!');
    } else {
        // Add new material
        const materialData = {
            id: Date.now(),
            projectId: projectId,
            name: name,
            category: category,
            quantityNeeded: quantityNeeded,
            quantityObtained: 0,
            unit: unit,
            estimatedCost: estimatedCost,
            actualCost: 0,
            notes: notes,
            obtained: false,
            created: new Date().toISOString()
        };
        materials.push(materialData);
        alert('Material added successfully!');
    }
    
    localStorage.setItem('materials', JSON.stringify(materials));
    closeModal();
}

function projectReports() {
    // Calculate totals
    const totalProjects = projects.length;
    const totalMaterials = materials.length;
    const obtainedMaterials = materials.filter(m => m.obtained).length;
    const totalEstimated = materials.reduce((sum, m) => sum + m.estimatedCost, 0);
    const totalActual = materials.reduce((sum, m) => sum + m.actualCost, 0);
    
    // Project by project breakdown
    let reportContent = `üìä PROJECT REPORTS\n\n`;
    reportContent += `OVERVIEW: ${totalProjects} projects ‚Ä¢ ${obtainedMaterials}/${totalMaterials} materials obtained ‚Ä¢ $${totalActual.toFixed(2)} of $${totalEstimated.toFixed(2)} spent\n\n`;
    
    // Sort projects by priority (urgent first)
    const priorityOrder = {'urgent': 4, 'high': 3, 'medium': 2, 'low': 1};
    const sortedProjects = projects.sort((a, b) => 
        (priorityOrder[b.priority] || 1) - (priorityOrder[a.priority] || 1)
    );
    
    reportContent += `‚îÅ‚îÅ‚îÅ PROJECT BREAKDOWN ‚îÅ‚îÅ‚îÅ\n\n`;
    
    sortedProjects.forEach(project => {
        const projectMaterials = materials.filter(m => m.projectId == project.id);
        const obtainedCount = projectMaterials.filter(m => m.obtained).length;
        const projectEstimated = projectMaterials.reduce((sum, m) => sum + m.estimatedCost, 0);
        const projectActual = projectMaterials.reduce((sum, m) => sum + m.actualCost, 0);
        const variance = projectActual - projectEstimated;
        
        const priorityIcon = project.priority === 'urgent' ? 'üö®' : 
                            project.priority === 'high' ? 'üî¥' : 
                            project.priority === 'medium' ? 'üü°' : 'üü¢';
        
        const dueDate = project.dueDate ? new Date(project.dueDate).toLocaleDateString() : 'No due date';
        const isOverdue = project.dueDate && new Date(project.dueDate) < new Date();
        
        reportContent += `${priorityIcon} ${project.name.toUpperCase()}${isOverdue ? ' [OVERDUE]' : ''}\n`;
        reportContent += `Due: ${dueDate} ‚Ä¢ Materials: ${obtainedCount}/${projectMaterials.length}\n`;
        reportContent += `Budget: $${projectEstimated.toFixed(2)} ‚Ä¢ Spent: $${projectActual.toFixed(2)}`;
        
        if (variance !== 0) {
            reportContent += variance > 0 ? ` [OVER by $${variance.toFixed(2)}]` : ` [UNDER by $${Math.abs(variance).toFixed(2)}]`;
        }
        reportContent += `\n\n`;
    });
    
    // Shopping list by priority
    const needToObtain = materials.filter(m => !m.obtained);
    if (needToObtain.length > 0) {
        reportContent += `‚îÅ‚îÅ‚îÅ SHOPPING LIST (${needToObtain.length} items) ‚îÅ‚îÅ‚îÅ\n\n`;
        
        // Group by project priority
        const shoppingByPriority = {};
        needToObtain.forEach(material => {
            const project = projects.find(p => p.id == material.projectId);
            const priority = project ? project.priority : 'unknown';
            if (!shoppingByPriority[priority]) {
                shoppingByPriority[priority] = [];
            }
            shoppingByPriority[priority].push({...material, projectName: project?.name || 'Unknown Project'});
        });
        
        // Display by priority order
        ['urgent', 'high', 'medium', 'low'].forEach(priority => {
            if (shoppingByPriority[priority]) {
                const priorityIcon = priority === 'urgent' ? 'üö®' : 
                                   priority === 'high' ? 'üî¥' : 
                                   priority === 'medium' ? 'üü°' : 'üü¢';
                
                reportContent += `${priorityIcon} ${priority.toUpperCase()} PRIORITY:\n`;
                
                shoppingByPriority[priority].forEach(item => {
                    const categoryIcon = {
                        lumber: 'ü™µ', hardware: 'üî©', tools: 'üî®', 
                        concrete: 'üß±', paint: 'üé®', electrical: '‚ö°', other: 'üì¶'
                    }[item.category] || 'üì¶';
                    
                    reportContent += `  ${categoryIcon} ${item.name} (${item.quantityNeeded} ${item.unit}) - $${item.estimatedCost.toFixed(2)}\n`;
                    reportContent += `      for ${item.projectName}`;
                    if (item.notes) reportContent += ` ‚Ä¢ ${item.notes}`;
                    reportContent += `\n`;
                });
                reportContent += `\n`;
            }
        });
        
        const totalShoppingCost = needToObtain.reduce((sum, m) => sum + m.estimatedCost, 0);
        reportContent += `TOTAL SHOPPING COST: $${totalShoppingCost.toFixed(2)}\n\n`;
    } else {
        reportContent += `‚úÖ ALL MATERIALS OBTAINED!\n\n`;
    }
    
    alert(reportContent);
}

function markAsObtained(materialId) {
    const material = materials.find(m => m.id == materialId);
    if (!material) return;
    
    document.getElementById('obtainedQuantity').value = material.quantityNeeded;
    document.getElementById('actualCost').value = material.estimatedCost;
    document.getElementById('obtainedMaterialId').value = materialId;
    document.getElementById('obtainedModal').style.display = 'block';
}

function markMaterialObtained() {
    const materialId = document.getElementById('obtainedMaterialId').value;
    const quantityObtained = parseFloat(document.getElementById('obtainedQuantity').value) || 0;
    const actualCost = parseFloat(document.getElementById('actualCost').value) || 0;
    
    const material = materials.find(m => m.id == materialId);
    if (material) {
        material.quantityObtained = quantityObtained;
        material.actualCost = actualCost;
        material.obtained = quantityObtained >= material.quantityNeeded;
        
        localStorage.setItem('materials', JSON.stringify(materials));
        displayProjects();
        closeModal();
        alert('Material marked as obtained!');
    }
}

function editMaterial(materialId) {
    const material = materials.find(m => m.id == materialId);
    if (!material) return;
    
    updateMaterialProjectDropdown();
    
    document.getElementById('materialProject').value = material.projectId;
    document.getElementById('materialName').value = material.name;
    document.getElementById('materialCategory').value = material.category;
    document.getElementById('materialQuantityNeeded').value = material.quantityNeeded;
    document.getElementById('materialUnit').value = material.unit;
    document.getElementById('materialEstimatedCost').value = material.estimatedCost;
    document.getElementById('materialNotes').value = material.notes;
    document.getElementById('materialEditId').value = materialId;
    document.getElementById('materialsModalTitle').textContent = 'Edit Material';
    
    document.getElementById('materialsModal').style.display = 'block';
}

function deleteMaterial(materialId) {
    const material = materials.find(m => m.id == materialId);
    if (!material) return;
    
    if (confirm(`Are you sure you want to delete "${material.name}"?`)) {
        materials = materials.filter(m => m.id != materialId);
        localStorage.setItem('materials', JSON.stringify(materials));
        displayProjects();
        alert('Material deleted successfully!');
    }
} 

// CUSTOM SHREDDING AREA SYSTEM
function initializeCustomShredMap() {
    initializeWeedSystem();
    displayShreddingAreas();
    updateAreaStats();
}

function toggleEditMode() {
    isEditMode = !isEditMode;
    const button = document.getElementById('editAreasBtn');
    const statusDiv = document.getElementById('edit-mode-status');
    
    if (isEditMode) {
        button.innerHTML = '‚úÖ DONE EDITING';
        button.className = 'btn btn-secondary';
        statusDiv.classList.remove('hidden');
        document.querySelectorAll('.shredding-area').forEach(area => {
            area.classList.add('edit-mode');
        });
    } else {
        button.innerHTML = '‚úèÔ∏è EDIT AREAS';
        button.className = 'btn btn-primary';
        statusDiv.classList.add('hidden');
        document.querySelectorAll('.shredding-area').forEach(area => {
            area.classList.remove('edit-mode', 'selected');
        });
        selectedArea = null;
    }
}

function addNewArea() {
    document.getElementById('areaModalTitle').textContent = 'Create New Shredding Area';
    document.getElementById('areaName').value = '';
    document.getElementById('areaShape').value = 'rectangle';
    document.getElementById('areaSize').value = 'medium';
    document.getElementById('areaEditId').value = '';
    document.getElementById('deleteAreaBtn').style.display = 'none';
    document.getElementById('areaModal').style.display = 'block';
}

function addNewLine() {
    document.getElementById('lineModalTitle').textContent = 'Create New Line';
    document.getElementById('lineName').value = '';
    document.getElementById('lineType').value = 'fence';
    document.getElementById('lineDirection').value = 'horizontal';
    document.getElementById('lineLength').value = 'medium';
    document.getElementById('lineStyle').value = 'solid';
    document.getElementById('lineEditId').value = '';
    document.getElementById('deleteLineBtn').style.display = 'none';
    document.getElementById('lineModal').style.display = 'block';
}

function createLine() {
    const name = document.getElementById('lineName').value.trim();
    const type = document.getElementById('lineType').value;
    const direction = document.getElementById('lineDirection').value;
    const length = document.getElementById('lineLength').value;
    const style = document.getElementById('lineStyle').value;
    const editId = document.getElementById('lineEditId').value;
    
    // Length mappings (percentages of map width/height)
    const lengthMap = {
        short: 15,
        medium: 25, 
        long: 40,
        extralong: 60
    };
    
    if (editId) {
        // Edit existing line
        const line = ranchLines.find(l => l.id == editId);
        if (line) {
            line.name = name;
            line.type = type;
            line.direction = direction;
            line.length = lengthMap[length];
            line.style = style;
        }
        alert(`${name || 'Line'} updated!`);
    } else {
        // Create new line
        const newLine = {
            id: Date.now(),
            name: name || `${type} line`,
            type: type,
            direction: direction,
            length: lengthMap[length],
            style: style,
            position: {
                x: 50, // start in center
                y: 50
            }
        };
        
        ranchLines.push(newLine);
        alert(`${newLine.name} created! Click anywhere on the map to position it.`);
    }
    
    saveRanchLines();
    closeModal();
    
    // Enable positioning mode if new line
    if (!editId) {
        enableLinePositioning();
    }
}

let linePositioningMode = false;
let tempLine = null;

function enableLinePositioning() {
    linePositioningMode = true;
    tempLine = ranchLines[ranchLines.length - 1]; // Get the newest line
    
    const mapContainer = document.getElementById('ranch-map-container');
    mapContainer.style.cursor = 'crosshair';
    mapContainer.onclick = positionLine;
    
    // Show instruction
    const instruction = document.createElement('div');
    instruction.id = 'line-positioning-instruction';
    instruction.style.cssText = `
        position: absolute; top: 10px; left: 10px; right: 10px;
        background: rgba(0,123,255,0.9); color: white; padding: 0.5rem;
        border-radius: 8px; text-align: center; z-index: 1000;
        font-weight: bold;
    `;
    instruction.textContent = `Click anywhere on the map to position "${tempLine.name}"`;
    mapContainer.appendChild(instruction);
}

function positionLine(event) {
    if (!linePositioningMode || !tempLine) return;
    
    const mapContainer = document.getElementById('ranch-map-container');
    const rect = mapContainer.getBoundingClientRect();
    
    // Calculate click position as percentage
    const x = ((event.clientX - rect.left) / rect.width) * 100;
    const y = ((event.clientY - rect.top) / rect.height) * 100;
    
    // Update line position
    tempLine.position.x = Math.max(0, Math.min(100, x));
    tempLine.position.y = Math.max(0, Math.min(100, y));
    
    // Disable positioning mode
    linePositioningMode = false;
    tempLine = null;
    mapContainer.style.cursor = 'default';
    mapContainer.onclick = null;
    
    // Remove instruction
    const instruction = document.getElementById('line-positioning-instruction');
    if (instruction) instruction.remove();
    
    // Save and refresh
    saveRanchLines();
    displayRanchLines();
    
    alert('Line positioned! Enter Edit Mode to move it again.');
}

function displayRanchLines() {
    const container = document.getElementById('shredding-areas'); // Same container as areas
    
    // Remove existing lines
    document.querySelectorAll('.ranch-line').forEach(line => line.remove());
    
    ranchLines.forEach(line => {
        const lineDiv = document.createElement('div');
        lineDiv.className = `ranch-line ${line.type} ${line.direction} ${line.style}`;
        lineDiv.style.position = 'absolute';
        lineDiv.style.left = line.position.x + '%';
        lineDiv.style.top = line.position.y + '%';
        lineDiv.title = line.name;
        lineDiv.onclick = () => handleLineClick(line);
        
        // Set line dimensions based on direction
        if (line.direction === 'horizontal') {
            lineDiv.style.width = line.length + '%';
            lineDiv.style.height = '3px';
        } else if (line.direction === 'vertical') {
            lineDiv.style.width = '3px';
            lineDiv.style.height = line.length + '%';
        } else if (line.direction === 'diagonal-ne') {
            lineDiv.style.width = line.length + '%';
            lineDiv.style.height = '3px';
            lineDiv.style.transform = 'rotate(45deg)';
            lineDiv.style.transformOrigin = 'left center';
        } else if (line.direction === 'diagonal-nw') {
            lineDiv.style.width = line.length + '%';
            lineDiv.style.height = '3px';
            lineDiv.style.transform = 'rotate(-45deg)';
            lineDiv.style.transformOrigin = 'left center';
        }
        
        container.appendChild(lineDiv);
    });
}

function handleLineClick(line) {
    if (isEditMode) {
        editLine(line);
    } else {
        // Do nothing for now - lines don't have a non-edit action like areas do
    }
}

function editLine(line) {
    // Set line data in edit modal
    document.getElementById('editLineName').value = line.name;
    document.getElementById('editLineType').value = line.type;
    document.getElementById('editLineDirection').value = line.direction;
    document.getElementById('editLineLength').value = getLengthOption(line.length);
    document.getElementById('editLineStyle').value = line.style;
    document.getElementById('editLineId').value = line.id;
    
    // Show edit modal
    document.getElementById('editLineModal').style.display = 'block';
}

function getLengthOption(length) {
    if (length <= 15) return 'short';
    if (length <= 25) return 'medium';
    if (length <= 40) return 'long';
    return 'extralong';
}

function saveLineEdits() {
    const lineId = document.getElementById('editLineId').value;
    const name = document.getElementById('editLineName').value.trim();
    const type = document.getElementById('editLineType').value;
    const direction = document.getElementById('editLineDirection').value;
    const length = document.getElementById('editLineLength').value;
    const style = document.getElementById('editLineStyle').value;
    
    const lengthMap = {
        short: 15,
        medium: 25,
        long: 40,
        extralong: 60
    };
    
    const line = ranchLines.find(l => l.id == lineId);
    if (line) {
        line.name = name || `${type} line`;
        line.type = type;
        line.direction = direction;
        line.length = lengthMap[length];
        line.style = style;
        
        saveRanchLines();
        displayRanchLines();
        closeModal();
        alert('Line updated successfully!');
    }
}

function startMoveLine() {
    const lineId = document.getElementById('editLineId').value;
    tempLine = ranchLines.find(l => l.id == lineId);
    closeModal();
    enableLinePositioning();
}

function confirmDeleteLine() {
    const lineId = document.getElementById('editLineId').value;
    const line = ranchLines.find(l => l.id == lineId);
    
    if (confirm(`Delete "${line.name}" permanently?`)) {
        ranchLines = ranchLines.filter(l => l.id != lineId);
        saveRanchLines();
        displayRanchLines();
        closeModal();
        alert('Line deleted successfully!');
    }
}

        
function saveRanchLines() {
    localStorage.setItem('ranchLines', JSON.stringify(ranchLines));
}
        
function createArea() {
    const name = document.getElementById('areaName').value.trim();
    const shape = document.getElementById('areaShape').value;
    const size = document.getElementById('areaSize').value;
    const editId = document.getElementById('areaEditId').value;
    
    if (!name) {
        alert('Please enter an area name');
        return;
    }
    
    // Size mappings
const sizeMap = {
    tiny: { width: 8, height: 6 },
    small: { width: 15, height: 10 },
    medium: { width: 25, height: 18 },
    large: { width: 35, height: 25 },
    huge: { width: 50, height: 35 }
};
    
    if (editId) {
        // Edit existing area
        const area = shreddingAreas.find(a => a.id == editId);
        if (area) {
            area.name = name;
            area.shape = shape;
            const newSize = sizeMap[size];
            area.position.width = newSize.width;
            area.position.height = newSize.height;
        }
        alert(`${name} updated!`);
    } else {
        // Create new area
        const newArea = {
            id: Date.now(),
            name: name,
            shape: shape,
            position: {
                x: 50, // percentage from left
                y: 50, // percentage from top
                width: sizeMap[size].width,
                height: sizeMap[size].height
            },
            polygonPoints: shape === 'polygon' ? [] : null,
            lastShredded: null,
            lastSprayed: null,
            sprayHistory: [],
            sprayNotes: [], 
            history: [],
            notes: []
        };
        
        shreddingAreas.push(newArea);
        tempArea = newArea;  // Set reference for positioning
        alert(`${name} created! Click anywhere on the map to position it.`);
    }

    saveShreddingAreas();
    displayShreddingAreas();
    updateAreaStats();
    closeModal();

    // Enable positioning mode if new area
    if (!editId) {
        enablePositioningMode();
    }
}

function displayShreddingAreas() {
    const container = document.getElementById('shredding-areas');
    container.innerHTML = '';
    
    shreddingAreas.forEach(area => {
        const areaDiv = document.createElement('div');
        areaDiv.className = `shredding-area ${area.shape} ${getAreaColorClass(area)}`;
        areaDiv.style.left = area.position.x + '%';
        areaDiv.style.top = area.position.y + '%';
        areaDiv.style.width = area.position.width + '%';
        areaDiv.style.height = area.position.height + '%';
        areaDiv.textContent = area.name;
        areaDiv.title = getAreaTooltip(area);
        
        areaDiv.onclick = () => handleAreaClick(area);  
        container.appendChild(areaDiv);
    });

        displayRanchLines();
}

function getAreaColorClass(area) {
    const shredDays = area.lastShredded ? (Date.now() - new Date(area.lastShredded)) / (1000 * 60 * 60 * 24) : 999;
    const sprayDays = area.lastSprayed ? (Date.now() - new Date(area.lastSprayed)) / (1000 * 60 * 60 * 24) : 999;
    
    // Use the most recent action (either shred or spray)
    const daysSince = Math.min(shredDays, sprayDays);
    
    if (!area.lastShredded && !area.lastSprayed) return 'never-shredded';
    if (daysSince <= 30) return 'recent';
    if (daysSince <= 60) return 'needs-attention';
    return 'overdue';
}

function getAreaTooltip(area) {
    let tooltip = area.name;
    
    if (area.lastShredded) {
        const shredDays = Math.floor((Date.now() - new Date(area.lastShredded)) / (1000 * 60 * 60 * 24));
        const shredDate = new Date(area.lastShredded).toLocaleDateString();
        tooltip += `\nLast shredded: ${shredDate} (${shredDays} days ago)`;
    }
    
    if (area.lastSprayed) {
        const sprayDays = Math.floor((Date.now() - new Date(area.lastSprayed)) / (1000 * 60 * 60 * 24));
        const sprayDate = new Date(area.lastSprayed).toLocaleDateString();
        tooltip += `\nLast sprayed: ${sprayDate} (${sprayDays} days ago)`;
    }
    
    if (!area.lastShredded && !area.lastSprayed) {
        tooltip += '\nNever shredded or sprayed';
    }
    
    return tooltip;
}

function markAreaShredded(area) {
    document.getElementById('shreddingAreaName').textContent = area.name;
    document.getElementById('shreddingAreaId').value = area.id;
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('shreddingDate').value = today;
    document.getElementById('shreddingNotes').value = '';
    
    // Show current status
    const statusDiv = document.getElementById('shreddingAreaStatus');
    if (area.lastShredded) {
        const daysSince = Math.floor((Date.now() - new Date(area.lastShredded)) / (1000 * 60 * 60 * 24));
        const lastDate = new Date(area.lastShredded).toLocaleDateString();
        statusDiv.textContent = `Last shredded: ${lastDate} (${daysSince} days ago)`;
    } else {
        statusDiv.textContent = 'Never been shredded';
    }
    
    document.getElementById('shreddingModal').style.display = 'block';
}

function confirmShredding() {
    const areaId = document.getElementById('shreddingAreaId').value;
    const shreddingDate = document.getElementById('shreddingDate').value;
    const notes = document.getElementById('shreddingNotes').value.trim();
    
    if (!shreddingDate) {
        alert('Please select a date');
        return;
    }
    
    const area = shreddingAreas.find(a => a.id == areaId);
    if (!area) return;
    
    area.lastShredded = shreddingDate;
    area.history.unshift(shreddingDate);
    
    if (notes) {
        area.notes.unshift({
            date: shreddingDate,
            note: notes
        });
    }

    // Keep only last 10 entries
    if (area.history.length > 10) area.history = area.history.slice(0, 10);
    if (area.notes.length > 10) area.notes = area.notes.slice(0, 10);
    
    saveShreddingAreas();
    displayShreddingAreas();
    updateAreaStats();
    closeModal();
    
    alert(`${area.name} marked as shredded on ${new Date(shreddingDate).toLocaleDateString()}!`);
}


function confirmSpraying() {
    const areaId = document.getElementById('shreddingAreaId').value;
    const sprayDate = document.getElementById('shreddingDate').value;
    const notes = document.getElementById('shreddingNotes').value.trim();
    
    if (!sprayDate) {
        alert('Please select a date');
        return;
    }
    
    const area = shreddingAreas.find(a => a.id == areaId);
    if (!area) return;
    
    // Initialize spray fields if they don't exist (for existing areas)
if (!area.sprayHistory) area.sprayHistory = [];
if (!area.sprayNotes) area.sprayNotes = [];

area.lastSprayed = sprayDate;
area.sprayHistory.unshift(sprayDate);

if (notes) {
    area.sprayNotes.unshift({
        date: sprayDate,
        note: notes
    });
}
    
    // Keep only last 10 entries
    if (area.sprayHistory.length > 10) area.sprayHistory = area.sprayHistory.slice(0, 10);
    if (area.sprayNotes.length > 10) area.sprayNotes = area.sprayNotes.slice(0, 10);
    
    saveShreddingAreas();
    displayShreddingAreas();
    updateAreaStats();
    closeModal();
    
    alert(`${area.name} marked as sprayed on ${new Date(sprayDate).toLocaleDateString()}!`);
}

        
function viewAreaHistory() {
    const areaId = document.getElementById('shreddingAreaId').value;
    const area = shreddingAreas.find(a => a.id == areaId);
    if (!area) return;
    
    let history = `üìÖ ${area.name.toUpperCase()} HISTORY\n\n`;
    
    // Shredding history
    if (area.history && area.history.length > 0) {
        history += 'SHREDDING DATES:\n';
        area.history.forEach((date, index) => {
            const daysSince = Math.floor((Date.now() - new Date(date)) / (1000 * 60 * 60 * 24));
            history += `${index + 1}. ${new Date(date).toLocaleDateString()} (${daysSince} days ago)\n`;
            
            // Add notes if any
            const note = area.notes && area.notes.find(n => n.date === date);
            if (note) {
                history += `   üìù ${note.note}\n`;
            }
        });
        history += '\n';
    }
    
    // Spray history
    if (area.sprayHistory && area.sprayHistory.length > 0) {
        history += 'SPRAY DATES:\n';
        area.sprayHistory.forEach((date, index) => {
            const daysSince = Math.floor((Date.now() - new Date(date)) / (1000 * 60 * 60 * 24));
            history += `${index + 1}. ${new Date(date).toLocaleDateString()} (${daysSince} days ago)\n`;
            
            // Add notes if any
            const note = area.sprayNotes && area.sprayNotes.find(n => n.date === date);
            if (note) {
                history += `   üìù ${note.note}\n`;
            }
        });
        history += '\n';
    }
    
    // If no history at all
    if ((!area.history || area.history.length === 0) && (!area.sprayHistory || area.sprayHistory.length === 0)) {
        history += 'No shredding or spray history yet.';
    }
    
    alert(history);
}

function handleAreaClick(area) {
    if (isEditMode === true) {
        editArea(area);
    } else {
        markAreaShredded(area);
    }
}

function editAreaProperties() {
    const areaId = document.getElementById('editAreaId').value;
    const newName = document.getElementById('editAreaName').value.trim();
    
    if (!newName) {
        alert('Please enter an area name');
        return;
    }
    
    const area = shreddingAreas.find(a => a.id == areaId);
    if (area) {
        area.name = newName;
        saveShreddingAreas();
        displayShreddingAreas();
        updateAreaStats();
    }
    closeModal();
}
        
function startMoveArea() {
    const areaId = document.getElementById('editAreaId').value;
    tempArea = shreddingAreas.find(a => a.id == areaId);
    
    if (!tempArea) {
        alert('Error: Could not find area to move');
        return;
    }
    
    closeModal();
    enablePositioningMode();
}


function startResizeArea() {
    const areaId = document.getElementById('editAreaId').value;
    const area = shreddingAreas.find(a => a.id == areaId);
    
    // Set current values in resize modal
    document.getElementById('resizeAreaId').value = areaId;
    document.getElementById('resizeAreaName').textContent = area.name;
    
    // Set current size as selected
    const currentSize = getCurrentSizeOption(area.position.width, area.position.height);
    document.getElementById('resizeAreaSize').value = currentSize;
    
    // Close edit modal and show resize modal
    closeModal();
    document.getElementById('resizeAreaModal').style.display = 'block';
}

function getCurrentSizeOption(width, height) {
    if (width <= 8) return 'tiny';
    if (width <= 15) return 'small';
    if (width <= 25) return 'medium';
    if (width <= 35) return 'large';
    return 'huge';
}

function confirmResize() {
    const areaId = document.getElementById('resizeAreaId').value;
    const newSize = document.getElementById('resizeAreaSize').value;
    const area = shreddingAreas.find(a => a.id == areaId);
    
    const sizeMap = {
        tiny: { width: 8, height: 6 },
        small: { width: 15, height: 10 },
        medium: { width: 25, height: 18 },
        large: { width: 35, height: 25 },
        huge: { width: 50, height: 35 }
    };
    
    if (area && sizeMap[newSize]) {
        area.position.width = sizeMap[newSize].width;
        area.position.height = sizeMap[newSize].height;
        
        saveShreddingAreas();
        displayShreddingAreas();
        updateAreaStats();
        closeModal();
        alert('Area resized successfully!');
    }
}
        
function confirmDeleteEditArea() {
    const areaId = document.getElementById('editAreaId').value;
    const area = shreddingAreas.find(a => a.id == areaId);
    
    if (confirm(`Delete "${area.name}" permanently?\n\nThis will remove all shredding history.`)) {
        shreddingAreas = shreddingAreas.filter(a => a.id != areaId);
        saveShreddingAreas();
        displayShreddingAreas();
        updateAreaStats();
        closeModal();
        alert('Area deleted successfully!');
    }
}


function editArea(area) {
    
    selectedArea = area;
    
    // Visual selection
    document.querySelectorAll('.shredding-area').forEach(el => el.classList.remove('selected'));
    
    event.target.classList.add('selected');
    
    // Set area data in modal
    document.getElementById('editAreaName').value = area.name;
    
    document.getElementById('editAreaId').value = area.id;
    
    // Show edit modal
    document.getElementById('editAreaModal').style.display = 'block';
}

        
function deleteArea(area) {
    if (confirm(`Delete "${area.name}" permanently?`)) {
        shreddingAreas = shreddingAreas.filter(a => a.id !== area.id);
        saveShreddingAreas();
        displayShreddingAreas();
        updateAreaStats();
        selectedArea = null;
    }
}

function viewShredHistory() {
    let report = 'üåæ SHREDDING HISTORY REPORT\n\n';
    
    if (shreddingAreas.length === 0) {
        alert('No shredding areas defined yet!');
        return;
    }
    
    // Sort by priority (overdue first)
    const sortedAreas = [...shreddingAreas].sort((a, b) => {
        const aDays = a.lastShredded ? (Date.now() - new Date(a.lastShredded)) / (1000 * 60 * 60 * 24) : 999;
        const bDays = b.lastShredded ? (Date.now() - new Date(b.lastShredded)) / (1000 * 60 * 60 * 24) : 999;
        return bDays - aDays;
    });
    
    sortedAreas.forEach(area => {
        const status = getAreaColorClass(area);
        const icon = status === 'overdue' ? 'üî¥' : 
                    status === 'needs-attention' ? 'üü°' : 
                    status === 'recent' ? 'üü¢' : '‚ö´';
        
        report += `${icon} ${area.name.toUpperCase()}\n`;
        
        if (area.lastShredded) {
            const daysSince = Math.floor((Date.now() - new Date(area.lastShredded)) / (1000 * 60 * 60 * 24));
            report += `Last shredded: ${new Date(area.lastShredded).toLocaleDateString()} (${daysSince} days ago)\n`;
            
            if (area.history.length > 1) {
                report += `Previous: ${area.history.slice(1, 4).map(date => new Date(date).toLocaleDateString()).join(', ')}\n`;
            }
        } else {
            report += 'Never shredded\n';
        }
        report += '\n';
    });
    
    const totalAreas = shreddingAreas.length;
    const recentCount = shreddingAreas.filter(a => getAreaColorClass(a) === 'recent').length;
    const overdueCount = shreddingAreas.filter(a => getAreaColorClass(a) === 'overdue').length;
    
    report += `SUMMARY: ${totalAreas} areas ‚Ä¢ ${recentCount} recent ‚Ä¢ ${overdueCount} overdue`;
    
    alert(report);
}

function updateAreaStats() {
    const statsDiv = document.getElementById('area-stats');
    
    if (shreddingAreas.length === 0) {
        statsDiv.innerHTML = 'No areas defined yet';
        return;
    }
    
    const recent = shreddingAreas.filter(a => getAreaColorClass(a) === 'recent').length;
    const needsAttention = shreddingAreas.filter(a => getAreaColorClass(a) === 'needs-attention').length;
    const overdue = shreddingAreas.filter(a => getAreaColorClass(a) === 'overdue').length;
    const never = shreddingAreas.filter(a => getAreaColorClass(a) === 'never-shredded').length;
    
    statsDiv.innerHTML = `
        ${shreddingAreas.length} areas defined ‚Ä¢ 
        <span style="color: #28a745;">‚óè</span> ${recent} recent ‚Ä¢ 
        <span style="color: #ffc107;">‚óè</span> ${needsAttention} need attention ‚Ä¢ 
        <span style="color: #dc3545;">‚óè</span> ${overdue} overdue ‚Ä¢ 
        <span style="color: #6c757d;">‚óè</span> ${never} never shredded
    `;
}

let positioningMode = false;
let tempArea = null;

function enablePositioningMode() {
    
    positioningMode = true;
    
    const mapContainer = document.getElementById('ranch-map-container');
    mapContainer.style.cursor = 'crosshair';
    mapContainer.onclick = positionArea;
    
    // Show instruction
    const instruction = document.createElement('div');
    instruction.id = 'positioning-instruction';
    instruction.style.cssText = `
        position: absolute; top: 10px; left: 10px; right: 10px;
        background: rgba(0,123,255,0.9); color: white; padding: 0.5rem;
        border-radius: 8px; text-align: center; z-index: 1000;
        font-weight: bold;
    `;
    instruction.textContent = `Click anywhere on the map to position "${tempArea.name}"`;
    mapContainer.appendChild(instruction);
}

function positionArea(event) {
    
    if (!positioningMode || !tempArea) return;
    
    const mapContainer = document.getElementById('ranch-map-container');
    const rect = mapContainer.getBoundingClientRect();
    
    // Calculate click position as percentage
    const x = ((event.clientX - rect.left) / rect.width) * 100;
    const y = ((event.clientY - rect.top) / rect.height) * 100;
    
    // Update the CORRECT area position (center it on click point)
    tempArea.position.x = Math.max(0, Math.min(100 - tempArea.position.width, x - tempArea.position.width/2));
    tempArea.position.y = Math.max(0, Math.min(100 - tempArea.position.height, y - tempArea.position.height/2));
    
    // Disable positioning mode
    positioningMode = false;
    tempArea = null;  // Clear the reference
    mapContainer.style.cursor = 'default';
    mapContainer.onclick = null;
    
    // Remove instruction
    const instruction = document.getElementById('positioning-instruction');
    if (instruction) instruction.remove();
    
    // Save and refresh
    saveShreddingAreas();
    displayShreddingAreas();
    
}

function editArea(area) {
    selectedArea = area;
    
    // Visual selection
    document.querySelectorAll('.shredding-area').forEach(el => el.classList.remove('selected'));
    event.target.classList.add('selected');
    
    // Show edit modal instead of prompt
    document.getElementById('editAreaName').value = area.name;
    document.getElementById('editAreaId').value = area.id;
    document.getElementById('editAreaModal').style.display = 'block';
}

function editAreaProperties() {
    const areaId = document.getElementById('editAreaId').value;
    const newName = document.getElementById('editAreaName').value.trim();
    
    if (!newName) {
        alert('Please enter an area name');
        return;
    }
    
    const area = shreddingAreas.find(a => a.id == areaId);
    if (area) {
        area.name = newName;
        saveShreddingAreas();
        displayShreddingAreas();
        updateAreaStats();
    }
    closeModal();
}

function startMoveArea() {
    
    const areaId = document.getElementById('editAreaId').value;
    
    tempArea = shreddingAreas.find(a => a.id == areaId);
    
    if (!tempArea) {
        return;
    }
    
    closeModal();
    enablePositioningMode();
}

function moveArea(area) {
    tempArea = area;
    enablePositioningMode();
}

function confirmDeleteArea() {
    const editId = document.getElementById('areaEditId').value;
    const area = shreddingAreas.find(a => a.id == editId);
    if (!area) return;
    
    if (confirm(`Delete "${area.name}" permanently?\n\nThis will remove all shredding history for this area.`)) {
        shreddingAreas = shreddingAreas.filter(a => a.id != editId);
        saveShreddingAreas();
        displayShreddingAreas();
        updateAreaStats();
        closeModal();
        alert('Area deleted successfully!');
    }
}

// CENTRAL TEXAS WEED MANAGEMENT SYSTEM
const weedDatabase = [
    {
        id: 'wooly-croton',
        name: 'Wooly Croton',
        scientificName: 'Croton capitatus',
        type: 'Annual',
        description: 'Most problematic Texas pasture weed. Gray-wooly appearance, spreads rapidly.',
        identifiers: ['Gray-wooly leaves', 'Clusters of small flowers', 'Grows 1-3 feet tall', 'Strong taproot'],
        seedTiming: 'August-October',
        peakSeason: 'July-September',
        optimalShred: 'May-June (before flowering), Late October (after seed drop)',
        avoidShred: 'July-September (spreading seeds while cutting)',
        sprayTiming: {
            primary: 'April-May (young plants)',
            secondary: 'September-October (fall regrowth)',
            chemical: '2,4-D at 1-2 lbs ae/acre',
            notes: 'Best control on young plants before flowering'
        },
        resistance: 'Develops 2,4-D resistance - rotate chemicals',
        monthlyActions: {
            'January': 'Plan spray program',
            'February': 'Order chemicals',
            'March': 'Pre-emergence if needed',
            'April': 'SPRAY - Young plants emerging',
            'May': 'SPRAY - Last chance before flowering',
            'June': 'SHRED - Before seed set',
            'July': 'AVOID - Seeds developing',
            'August': 'AVOID - Seeds dropping',
            'September': 'AVOID - Seeds dispersing',
            'October': 'SHRED - After seed drop complete',
            'November': 'SHRED - Safe period',
            'December': 'Plan next year'
        }
    },
    {
        id: 'dogfennel',
        name: 'Dogfennel',
        scientificName: 'Eupatorium capillifolium',
        type: 'Perennial',
        description: 'Tall, feathery perennial. Very persistent with extensive root system.',
        identifiers: ['Feathery, fine leaves', 'Grows 3-10 feet tall', 'White flower clusters', 'Strong smell when crushed'],
        seedTiming: 'September-November',
        peakSeason: 'August-October',
        optimalShred: 'June-July (weakens root system), November-December (after seed drop)',
        avoidShred: 'August-October (seed dispersal period)',
        sprayTiming: {
            primary: 'May-June (active growth)',
            secondary: 'September (fall treatment)',
            chemical: '2,4-D + Dicamba mix, or Grazon P+D',
            notes: 'Requires heavy rates, multiple treatments'
        },
        resistance: 'Very persistent - may need 2-3 years of treatment',
        monthlyActions: {
            'January': 'Plan aggressive control strategy',
            'February': 'Order specialized herbicides',
            'March': 'Early detection spraying',
            'April': 'Continue spray program',
            'May': 'SPRAY - Peak effectiveness',
            'June': 'SPRAY/SHRED - Multiple approaches',
            'July': 'SHRED - Weaken plants',
            'August': 'AVOID - Seed development',
            'September': 'SPRAY - Fall treatment window',
            'October': 'AVOID - Seeds dropping',
            'November': 'SHRED - Safe period',
            'December': 'Monitor for regrowth'
        }
    },
    {
        id: 'sesbania',
        name: 'Sesbania (Coffeeweed)',
        scientificName: 'Sesbania herbacea',
        type: 'Annual Legume',
        description: 'Fast-growing annual legume making a comeback. Toxic to livestock.',
        identifiers: ['Compound leaves', 'Yellow flowers', 'Long seed pods', 'Grows 3-8 feet tall'],
        seedTiming: 'September-October',
        peakSeason: 'July-September',
        optimalShred: 'June-July (before pod formation)',
        avoidShred: 'August-September (pods forming/dropping)',
        sprayTiming: {
            primary: 'April-May (young plants)',
            secondary: 'Early June (last chance)',
            chemical: '2,4-D at 2 lbs ae/acre + surfactant',
            notes: 'Harder to kill as it matures'
        },
        resistance: 'Can develop resistance - use tank mixes',
        monthlyActions: {
            'January': 'Plan early detection',
            'February': 'Prepare spray equipment',
            'March': 'Scout for early emergence',
            'April': 'SPRAY - Young plants',
            'May': 'SPRAY - Continue program',
            'June': 'SHRED - Before pod set',
            'July': 'Monitor - pods forming',
            'August': 'AVOID - pods maturing',
            'September': 'AVOID - seeds dropping',
            'October': 'Plan next year control',
            'November': 'Post-harvest assessment',
            'December': 'Equipment maintenance'
        }
    },
    {
        id: 'thistle',
        name: 'Bull Thistle',
        scientificName: 'Cirsium vulgare',
        type: 'Biennial',
        description: 'Spiny biennial weed. Deep taproot makes it persistent.',
        identifiers: ['Spiny leaves and stems', 'Purple flower heads', 'Grows 2-5 feet', 'Deep taproot'],
        seedTiming: 'July-September',
        peakSeason: 'June-August',
        optimalShred: 'April-May (rosette stage), October (after seed drop)',
        avoidShred: 'June-September (flowering and seeding)',
        sprayTiming: {
            primary: 'March-April (rosette stage)',
            secondary: 'October-November (fall rosettes)',
            chemical: '2,4-D at 1.5 lbs ae/acre',
            notes: 'Most effective on rosettes'
        },
        resistance: 'Generally sensitive to 2,4-D',
        monthlyActions: {
            'January': 'Plan spring program',
            'February': 'Scout for rosettes',
            'March': 'SPRAY - Rosette stage',
            'April': 'SPRAY/SHRED - Still effective',
            'May': 'SHRED - Last chance',
            'June': 'AVOID - Flowering',
            'July': 'AVOID - Peak seeding',
            'August': 'AVOID - Seeds dispersing',
            'September': 'AVOID - Late seeding',
            'October': 'SHRED - New rosettes',
            'November': 'SPRAY - Fall rosettes',
            'December': 'Equipment prep'
        }
    },
    {
        id: 'ragweed',
        name: 'Giant Ragweed',
        scientificName: 'Ambrosia trifida',
        type: 'Annual',
        description: 'Tall annual weed. Major allergen producer.',
        identifiers: ['Large 3-lobed leaves', 'Grows 6-12 feet tall', 'Wind-pollinated flowers', 'Massive seed production'],
        seedTiming: 'August-October',
        peakSeason: 'July-September',
        optimalShred: 'June-July (before flowering)',
        avoidShred: 'August-September (pollen and seed production)',
        sprayTiming: {
            primary: 'April-May (young plants)',
            secondary: 'Early June (before flowering)',
            chemical: '2,4-D at 1.5 lbs ae/acre + AMS',
            notes: 'Add surfactant for better control'
        },
        resistance: 'Some 2,4-D resistance reported',
        monthlyActions: {
            'January': 'Plan control strategy',
            'February': 'Order herbicides',
            'March': 'Early emergence spraying',
            'April': 'SPRAY - Peak effectiveness',
            'May': 'SPRAY - Continue program',
            'June': 'SHRED - Before flowering',
            'July': 'Monitor - flowering starting',
            'August': 'AVOID - Peak pollen/seeds',
            'September': 'AVOID - Seed dispersal',
            'October': 'Post-season cleanup',
            'November': 'Plan next year',
            'December': 'Equipment maintenance'
        }
    }
];

// Initialize weed management system
function initializeWeedSystem() {
    updateCurrentAlerts();
    updateSprayConditions();
}

function viewCurrentAlerts() {
    const currentMonth = new Date().toLocaleString('default', { month: 'long' });
    let alertsHtml = `<h3>üìÖ ${currentMonth} Weed Management</h3>`;
    
    weedDatabase.forEach(weed => {
        const action = weed.monthlyActions[currentMonth];
        const priority = action.includes('SPRAY') || action.includes('SHRED') ? 'high' : 
                        action.includes('AVOID') ? 'warning' : 'low';
        
        const bgColor = priority === 'high' ? '#d4edda' : 
                       priority === 'warning' ? '#fff3cd' : '#f8f9fa';
        const textColor = priority === 'high' ? '#155724' : 
                         priority === 'warning' ? '#856404' : '#666';
        
        alertsHtml += `
            <div style="background: ${bgColor}; padding: 0.75rem; margin: 0.5rem 0; border-radius: 8px; border-left: 4px solid ${priority === 'high' ? '#28a745' : priority === 'warning' ? '#ffc107' : '#6c757d'};">
                <strong style="color: ${textColor};">${weed.name}:</strong>
                <span style="color: ${textColor};">${action}</span>
            </div>
        `;
    });
    
    document.getElementById('monthlyAlerts').innerHTML = alertsHtml;
}

function updateCurrentAlerts() {
    viewCurrentAlerts();
}

function updateSprayConditions() {
    if (currentWeather) {
        const windSpeed = currentWeather.windSpeed;
        const temp = currentWeather.temp;
        const humidity = currentWeather.humidity;
        
        let conditions = '';
        let bgColor = '#f8f9fa';
        
        if (windSpeed <= 10 && temp >= 65 && temp <= 85 && humidity >= 40) {
            conditions = `‚úÖ EXCELLENT spray conditions! Wind: ${windSpeed}mph, Temp: ${temp}¬∞F, Humidity: ${humidity}%`;
            bgColor = '#d4edda';
        } else if (windSpeed <= 15 && temp >= 60 && temp <= 90) {
            conditions = `‚ö†Ô∏è Fair spray conditions. Wind: ${windSpeed}mph, Temp: ${temp}¬∞F - Use caution`;
            bgColor = '#fff3cd';
        } else {
            conditions = `‚ùå Poor spray conditions. Wind: ${windSpeed}mph, Temp: ${temp}¬∞F - Avoid spraying`;
            bgColor = '#f8d7da';
        }
        
        document.getElementById('conditionsContent').innerHTML = conditions;
        document.getElementById('sprayConditions').style.background = bgColor;
    }
}

function viewSpeciesGuide() {
    document.getElementById('speciesModal').style.display = 'block';
    displaySpeciesGuide();
}

function displaySpeciesGuide() {
    const container = document.getElementById('speciesContainer');
    let html = '';
    
    weedDatabase.forEach(weed => {
        const currentMonth = new Date().toLocaleString('default', { month: 'long' });
        const currentAction = weed.monthlyActions[currentMonth];
        const isActive = currentAction.includes('SPRAY') || currentAction.includes('SHRED');
        
        html += `
            <div class="species-card ${isActive ? 'active-season' : ''}" onclick="showSpeciesDetail('${weed.id}')">
                <div class="species-header">
                    <h3>${weed.name}</h3>
                    <span class="species-type">${weed.type}</span>
                </div>
                <div class="species-scientific">${weed.scientificName}</div>
                <div class="species-description">${weed.description}</div>
                <div class="species-current-action">
                    <strong>This Month:</strong> ${currentAction}
                </div>
                <div class="species-identifiers">
                    <strong>ID Features:</strong> ${weed.identifiers.slice(0, 2).join(', ')}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function showSpeciesDetail(weedId) {
    const weed = weedDatabase.find(w => w.id === weedId);
    if (!weed) return;
    
    const detail = document.getElementById('speciesDetail');
    detail.innerHTML = `
        <h2>${weed.name} (${weed.scientificName})</h2>
        <div class="detail-section">
            <h3>üîç Identification</h3>
            <ul>${weed.identifiers.map(id => `<li>${id}</li>`).join('')}</ul>
        </div>
        <div class="detail-section">
            <h3>üìÖ Timing</h3>
            <p><strong>Peak Season:</strong> ${weed.peakSeason}</p>
            <p><strong>Seeds Drop:</strong> ${weed.seedTiming}</p>
        </div>
        <div class="detail-section">
            <h3>üåæ Shredding Strategy</h3>
            <p><strong>Best Times:</strong> ${weed.optimalShred}</p>
            <p><strong>Avoid:</strong> ${weed.avoidShred}</p>
        </div>
        <div class="detail-section">
            <h3>üß™ Chemical Control</h3>
            <p><strong>Primary:</strong> ${weed.sprayTiming.primary}</p>
            <p><strong>Chemical:</strong> ${weed.sprayTiming.chemical}</p>
            <p><strong>Notes:</strong> ${weed.sprayTiming.notes}</p>
            <p><strong>Resistance:</strong> ${weed.resistance}</p>
        </div>
        <button onclick="backToSpeciesList()" class="btn btn-secondary">‚Üê Back to List</button>
    `;
    
    document.getElementById('speciesContainer').style.display = 'none';
    detail.style.display = 'block';
}

function backToSpeciesList() {
    document.getElementById('speciesContainer').style.display = 'block';
    document.getElementById('speciesDetail').style.display = 'none';
}

function viewCalendar() {
    alert('Calendar View coming in next step!');
}

function sprayCalculator() {
    document.getElementById('calculatorModal').style.display = 'block';
    initializeCalculator();
}

function initializeCalculator() {
    // Set default values
    document.getElementById('tankSize').value = '25';
    document.getElementById('acreage').value = '10';
    document.getElementById('herbicide').value = '2,4-D';
    calculateSprayMix();
}

function calculateSprayMix() {
    const tankSize = parseFloat(document.getElementById('tankSize').value) || 0;
    const acreage = parseFloat(document.getElementById('acreage').value) || 0;
    const herbicide = document.getElementById('herbicide').value;
    const weedType = document.getElementById('weedTarget').value;
    const addSurfactant = document.getElementById('surfactant').checked;
    const addDye = document.getElementById('blueDye').checked;
    
    if (tankSize <= 0 || acreage <= 0) {
        document.getElementById('calculatorResults').innerHTML = '<p>Please enter valid tank size and acreage</p>';
        return;
    }
    
    // Get herbicide rates based on weed and chemical
    const rates = getHerbicideRates(herbicide, weedType);
    
    // Calculate total spray solution needed
    const gpa = 15; // gallons per acre
    const totalSolutionNeeded = acreage * gpa;
    
    // Calculate how to fill tanks efficiently
    const fullTanks = Math.floor(totalSolutionNeeded / tankSize);
    const partialTankGallons = totalSolutionNeeded % tankSize;
    const totalTanks = fullTanks + (partialTankGallons > 0 ? 1 : 0);
    
    // Calculate total chemicals needed
    const totalHerbicideNeeded = rates.herbicide * acreage;
    const totalSurfactantNeeded = addSurfactant ? totalSolutionNeeded * 0.0025 : 0; // 0.25% v/v
    const totalDyeNeeded = addDye ? totalSolutionNeeded * 0.002 : 0; // 0.2% v/v
    
    // Create tank-by-tank breakdown
    let tankBreakdown = [];
    
    // Full tanks
    for (let i = 0; i < fullTanks; i++) {
        const waterInTank = tankSize;
        const herbicideInTank = (waterInTank / totalSolutionNeeded) * totalHerbicideNeeded;
        const surfactantInTank = addSurfactant ? waterInTank * 0.0025 : 0;
        const dyeInTank = addDye ? waterInTank * 0.002 : 0;
        
        tankBreakdown.push({
            tankNumber: i + 1,
            waterGallons: waterInTank,
            herbicideOz: herbicideInTank,
            surfactantOz: surfactantInTank * 128, // convert to fl oz
            dyeOz: dyeInTank * 128 // convert to fl oz
        });
    }
    
    // Partial tank if needed
    if (partialTankGallons > 0) {
        const waterInTank = partialTankGallons;
        const herbicideInTank = (waterInTank / totalSolutionNeeded) * totalHerbicideNeeded;
        const surfactantInTank = addSurfactant ? waterInTank * 0.0025 : 0;
        const dyeInTank = addDye ? waterInTank * 0.002 : 0;
        
        tankBreakdown.push({
            tankNumber: fullTanks + 1,
            waterGallons: waterInTank,
            herbicideOz: herbicideInTank,
            surfactantOz: surfactantInTank * 128,
            dyeOz: dyeInTank * 128
        });
    }
    
    // Calculate costs
    const herbicideCost = calculateChemicalCost(herbicide, totalHerbicideNeeded);
    const surfactantCost = addSurfactant ? calculateChemicalCost('surfactant', totalSurfactantNeeded * 128) : 0;
    const dyeCost = addDye ? calculateChemicalCost('blueDye', totalDyeNeeded * 128) : 0;
    
    displayCalculatorResults({
        tankSize, acreage, totalTanks, totalSolutionNeeded,
        totalHerbicideNeeded, totalSurfactantNeeded, totalDyeNeeded,
        herbicideCost, surfactantCost, dyeCost, rates, tankBreakdown
    });
}

function getHerbicideRates(chemical, weedType) {
    const rates = {
        '2,4-D': {
            'wooly-croton': { herbicide: 32, notes: 'Young plants - increase to 48 oz for mature' },
            'dogfennel': { herbicide: 48, notes: 'Heavy rate needed - consider tank mix' },
            'sesbania': { herbicide: 48, notes: 'Add surfactant for better control' },
            'thistle': { herbicide: 32, notes: 'Best on rosettes' },
            'ragweed': { herbicide: 32, notes: 'Add AMS (ammonium sulfate)' },
            'general': { herbicide: 32, notes: 'Standard broadleaf rate' }
        },
        'Grazon P+D': {
            'wooly-croton': { herbicide: 24, notes: 'Excellent on resistant populations' },
            'dogfennel': { herbicide: 32, notes: 'Best choice for persistent stands' },
            'sesbania': { herbicide: 24, notes: 'Good legume control' },
            'thistle': { herbicide: 16, notes: 'Very effective on thistles' },
            'ragweed': { herbicide: 24, notes: 'Good for resistant ragweed' },
            'general': { herbicide: 24, notes: 'Broad spectrum control' }
        },
        'Dicamba': {
            'wooly-croton': { herbicide: 8, notes: 'Tank mix with 2,4-D' },
            'dogfennel': { herbicide: 8, notes: 'Tank mix recommended' },
            'sesbania': { herbicide: 8, notes: 'Good on legumes' },
            'thistle': { herbicide: 8, notes: 'Excellent thistle control' },
            'ragweed': { herbicide: 8, notes: 'Tank mix for resistance' },
            'general': { herbicide: 8, notes: 'Always tank mix' }
        }
    };
    
    return rates[chemical]?.[weedType] || rates[chemical]?.['general'] || { herbicide: 32, notes: 'Standard rate' };
}

function calculateChemicalCost(chemical, amount) {
    const prices = {
        // Herbicides (per fluid ounce)
        '2,4-D': 0.35, // per fluid ounce (~$45/gallon)
        'Grazon P+D': 0.60, // per fluid ounce (~$75/gallon)
        'Dicamba': 0.75, // per fluid ounce (~$95/gallon)
        
        // Additives (per fluid ounce)
        'surfactant': 0.25, // ~$32.25/gallon √∑ 128 fl oz
        'blueDye': 0.78     // ~$99.84/gallon √∑ 128 fl oz
    };
    
    return (prices[chemical] || 0.40) * amount;
}

function displayCalculatorResults(calc) {
    const totalCost = calc.herbicideCost + calc.surfactantCost + calc.dyeCost;
    const costPerAcre = totalCost / calc.acreage;
    
    document.getElementById('calculatorResults').innerHTML = `
        <div class="calc-results">
            <h4>üß™ Spray Mix Calculator Results</h4>
            
            <div class="calc-summary">
                <div class="calc-item">
                    <span class="calc-label">Coverage:</span>
                    <span class="calc-value">${calc.acreage} acres in ${calc.totalTanks} tank(s)</span>
                </div>
                <div class="calc-item">
                    <span class="calc-label">Total Solution:</span>
                    <span class="calc-value">${calc.totalSolutionNeeded} gallons needed</span>
                </div>
                <div class="calc-item">
                    <span class="calc-label">Application Rate:</span>
                    <span class="calc-value">15 gallons per acre</span>
                </div>
            </div>
            
            <h5>üìã Tank-by-Tank Mixing:</h5>
            <div class="tank-breakdown">
                ${calc.tankBreakdown.map(tank => `
                    <div class="tank-mix">
                        <h6>Tank ${tank.tankNumber} (${tank.waterGallons.toFixed(1)} gallons):</h6>
                        <div class="mix-item">
                            <span class="mix-chemical">Water:</span>
                            <span class="mix-amount">${tank.waterGallons.toFixed(1)} gallons</span>
                        </div>
                        <div class="mix-item">
                            <span class="mix-chemical">Herbicide:</span>
                            <span class="mix-amount">${tank.herbicideOz.toFixed(1)} fl oz</span>
                        </div>
                        ${tank.surfactantOz > 0 ? `
                            <div class="mix-item">
                                <span class="mix-chemical">Surfactant (NIS):</span>
                                <span class="mix-amount">${tank.surfactantOz.toFixed(1)} fl oz</span>
                            </div>
                        ` : ''}
                        ${tank.dyeOz > 0 ? `
                            <div class="mix-item">
                                <span class="mix-chemical">Blue Dye:</span>
                                <span class="mix-amount">${tank.dyeOz.toFixed(1)} fl oz</span>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
            
            <h5>üí∞ Cost Breakdown:</h5>
            <div class="cost-breakdown">
                <div class="cost-item">
                    <span>Herbicide (${calc.totalHerbicideNeeded.toFixed(1)} fl oz total):</span>
                    <span>$${calc.herbicideCost.toFixed(2)}</span>
                </div>
                ${calc.surfactantCost > 0 ? `
                    <div class="cost-item">
                        <span>Surfactant:</span>
                        <span>$${calc.surfactantCost.toFixed(2)}</span>
                    </div>
                ` : ''}
                ${calc.dyeCost > 0 ? `
                    <div class="cost-item">
                        <span>Blue Dye:</span>
                        <span>$${calc.dyeCost.toFixed(2)}</span>
                    </div>
                ` : ''}
                <div class="cost-item total-cost">
                    <span><strong>Total Cost:</strong></span>
                    <span><strong>$${totalCost.toFixed(2)} ($${costPerAcre.toFixed(2)}/acre)</strong></span>
                </div>
            </div>
            
            <div class="calc-notes">
                <h5>üìù Application Notes:</h5>
                <p>${calc.rates.notes}</p>
                <p><strong>Spray Pressure:</strong> 30-40 PSI for good coverage</p>
                <p><strong>Speed:</strong> 5-7 MPH for even application</p>
                <p><strong>Weather:</strong> Wind &lt;10mph, temp 65-85¬∞F, no rain for 4+ hours</p>
            </div>
        </div>
    `;
}
        
function saveShreddingAreas() {
    localStorage.setItem('shreddingAreas', JSON.stringify(shreddingAreas));
}

// GPS BOUNDARY CAPTURE FUNCTIONS
let gpsRecording = {
    active: false,
    paused: false,
    watchId: null,
    points: [],
    fieldName: '',
    lastUpdate: null
};

function startGPSBoundaryCapture() {
    document.getElementById('gpsBoundaryModal').style.display = 'block';
    document.getElementById('gpsBoundaryName').value = '';
    document.getElementById('gpsStatus').classList.add('hidden');
    document.getElementById('gpsInstructions').classList.remove('hidden');
    document.getElementById('gpsStartBtn').classList.remove('hidden');
    document.getElementById('gpsStopBtn').classList.add('hidden');
    document.getElementById('gpsPauseBtn').classList.add('hidden');
    document.getElementById('gpsPointCount').textContent = '0';
    document.getElementById('gpsAccuracy').textContent = '--';
    document.getElementById('gpsLastUpdate').textContent = '--';
}

function startGPSRecording() {
    const fieldName = document.getElementById('gpsBoundaryName').value.trim();
    if (!fieldName) {
        alert('Please enter a field name first');
        return;
    }

    if (!navigator.geolocation) {
        alert('GPS is not supported by your browser');
        return;
    }

    gpsRecording.active = true;
    gpsRecording.paused = false;
    gpsRecording.points = [];
    gpsRecording.fieldName = fieldName;

    document.getElementById('gpsInstructions').classList.add('hidden');
    document.getElementById('gpsStatus').classList.remove('hidden');
    document.getElementById('gpsStartBtn').classList.add('hidden');
    document.getElementById('gpsStopBtn').classList.remove('hidden');
    document.getElementById('gpsPauseBtn').classList.remove('hidden');

    // Request high accuracy GPS
    const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
    };

    gpsRecording.watchId = navigator.geolocation.watchPosition(
        handleGPSSuccess,
        handleGPSError,
        options
    );
}

function handleGPSSuccess(position) {
    if (!gpsRecording.active || gpsRecording.paused) return;

    const point = {
        lat: position.coords.latitude,
        lon: position.coords.longitude,
        accuracy: position.coords.accuracy,
        timestamp: new Date().toISOString()
    };

    gpsRecording.points.push(point);
    gpsRecording.lastUpdate = new Date();

    // Update UI
    document.getElementById('gpsPointCount').textContent = gpsRecording.points.length;
    document.getElementById('gpsAccuracy').textContent = Math.round(point.accuracy);
    document.getElementById('gpsLastUpdate').textContent = new Date().toLocaleTimeString();

    console.log(`GPS point captured: ${point.lat}, ${point.lon} (accuracy: ${Math.round(point.accuracy)}m)`);
}

function handleGPSError(error) {
    console.error('GPS error:', error);
    let message = 'GPS error: ';
    switch (error.code) {
        case error.PERMISSION_DENIED:
            message += 'Location permission denied. Please enable location access.';
            break;
        case error.POSITION_UNAVAILABLE:
            message += 'Location information unavailable. Make sure GPS is enabled.';
            break;
        case error.TIMEOUT:
            message += 'Location request timed out. Make sure you have a clear view of the sky.';
            break;
        default:
            message += 'Unknown error occurred.';
    }
    alert(message);
}

function pauseGPSRecording() {
    if (!gpsRecording.active) return;

    gpsRecording.paused = !gpsRecording.paused;
    const pauseBtn = document.getElementById('gpsPauseBtn');

    if (gpsRecording.paused) {
        pauseBtn.textContent = '‚ñ∂Ô∏è Resume';
        pauseBtn.style.background = '#28a745';
    } else {
        pauseBtn.textContent = '‚è∏Ô∏è Pause';
        pauseBtn.style.background = '#6c757d';
    }
}

function finishGPSRecording() {
    if (!gpsRecording.active) return;

    if (gpsRecording.points.length < 3) {
        alert('Need at least 3 GPS points to create a boundary. Keep recording.');
        return;
    }

    // Stop GPS tracking
    if (gpsRecording.watchId) {
        navigator.geolocation.clearWatch(gpsRecording.watchId);
    }

    // Save the boundary
    const boundary = {
        id: Date.now(),
        name: gpsRecording.fieldName,
        points: gpsRecording.points,
        dateCreated: new Date().toISOString(),
        pointCount: gpsRecording.points.length,
        avgAccuracy: Math.round(gpsRecording.points.reduce((sum, p) => sum + p.accuracy, 0) / gpsRecording.points.length)
    };

    fieldBoundaries.push(boundary);
    localStorage.setItem('fieldBoundaries', JSON.stringify(fieldBoundaries));

    // Reset
    gpsRecording.active = false;
    gpsRecording.points = [];

    alert(`Field boundary saved!\n${boundary.pointCount} GPS points captured\nAverage accuracy: ${boundary.avgAccuracy} meters`);

    closeModal();
    displayFieldBoundaries();
}

function stopGPSRecording() {
    if (gpsRecording.watchId) {
        navigator.geolocation.clearWatch(gpsRecording.watchId);
    }
    gpsRecording.active = false;
    gpsRecording.points = [];
    closeModal();
}

function displayFieldBoundaries() {
    // For now, just log them. We'll add visual display later
    console.log('Field boundaries:', fieldBoundaries);

    if (fieldBoundaries.length > 0) {
        console.log(`You have ${fieldBoundaries.length} field(s) recorded:`);
        fieldBoundaries.forEach(field => {
            console.log(`- ${field.name}: ${field.pointCount} points, ${field.avgAccuracy}m avg accuracy`);
        });
    }
}

</script>
</body>
</html>
